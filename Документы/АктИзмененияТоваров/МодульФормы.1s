//СокрЛП(Формат(ПоказатьЦену()*(100+ПроцентНДС(СтавкаНДС))/100,"Ч10.2"))
Перем Режим;
Перем кОсновнаяКатегорияЦены,кРозничнаяКатегорияЦены;
Перем ВалютаСтар;
Перем пПрайсЛист;
перем СтавкаНДС;
Перем Таб;

Процедура ВывестиИТЗ(ТаблИТ)
	
	ТаблИТ.Сортировать("*Товар");
	ТаблИТ.ВыбратьСтроки();
	Пока ТаблИТ.ПолучитьСтроку()=1 Цикл
		Если ТаблИТ.__ЭтоГруппа__=1 Тогда
			сдвиг=Формат(" ","С"+(ТаблИТ.Товар.Уровень()-1)*3+"");
			ТекТовар=сдвиг+СокрЛП(ТаблИТ.Товар.Наименование);
			таб.ВывестиСекцию( "Группа" );
			таб_=ТаблИТ.тзПотомки;
			ВывестиИТЗ(таб_);
		Иначе
			сдвиг=Формат(" ","С"+(ТаблИТ.Товар.Уровень()-1)*4+"");                  
			ТекТовар=сдвиг+ТаблИТ.Товар.Код+?(СокрЛП(ТаблИТ.ТовКодСтар)<>СокрЛП(ТаблИТ.ТовКод)," ( <-- "+СокрЛП(ТаблИТ.ТовКодСтар)+")    ","     ")+СокрЛП(ТаблИТ.Товар.Наименование)+?(СокрЛП(ТаблИТ.НаименованиеСтар)<>СокрЛП(ТаблИТ.НаименованиеНов),"   <--- ("+СокрЛП(ТаблИТ.НаименованиеСтар)+")","");
			ПечВидТовара = ТаблИТ.Товар.ВидТовара;
			таб.ВывестиСекцию( "Строка" );                                                                   
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры


Процедура кнРассылка()
	Если Модифицированность() = 1 Тогда
		Ответ = Вопрос("Документ не был записан после внесенных изменений. Записать?","Да+Нет",60);
		Если Ответ <> "Да" Тогда Возврат; КонецЕсли;
		Записать(); 
	КонецЕсли;
	сп = СоздатьОбъект( "СписокЗначений" );
	сп.Установить("Документ",ТекущийДокумент());
	Путь = КаталогИБ() + "ExtForms\РассылкаПрайсЛиста.ert";
	ОткрытьФормуМодально("Отчет",сп,Путь);
КонецПроцедуры

Процедура ПриУдаленииСтроки()    
КонецПроцедуры

Процедура кнЗаполнить()
	
	НаимСтар = "НаименованиеСтар"+?(глКодСтраныПользователя="LV","",глКодСтраныПользователя);
	НаимНов = "НаименованиеНов"+?(глКодСтраныПользователя="LV","",глКодСтраныПользователя);
	
	ТекстЗапроса = "SELECT ТоварID [Товар $Справочник.Номенклатура]
	|					   , Пользователь
	|					   , $НачалоПериода.День(CONVERT(VARCHAR,ДатаВремя,112),Строка) [Дата $Дата]
	|					   , CONVERT(VARCHAR(8),ДатаВремя,108) Время
	|					   , ДатаВремя
	|					   , СпрС.ID [Сотрудник $Справочник.Сотрудники]
	|					   , КодСтар as ТовКодСтар
	|					   , КодНов as ТовКод
	|					   , "+НаимСтар+" as НаименованиеСтар
	|					   , "+НаимНов+" as НаименованиеНов
	|				FROM НоменклатураИсторияИзменений
	|				LEFT JOIN $Справочник.Пользователи СпрП (NOLOCK) ON СпрП.CODE=Пользователь
	|				LEFT JOIN $Справочник.Сотрудники СпрС (NOLOCK) ON $СпрП.Сотрудник = СпрС.ID
	|				INNER JOIN  $Справочник.Номенклатура СпрН (NOLOCK) ON СпрН.ID = ТоварID
	|				WHERE ДатаВремя BETWEEN :Нач AND :Кон AND ("+НаимСтар+" <> "+НаимНов + " OR КодСтар <> КодНов)
	|					  AND (CONVERT(VARCHAR(8),ДатаВремя,108)>='06:00' AND CONVERT(VARCHAR(8),ДатаВремя,108)<'23:00')
	|					  AND Пользователь<>'MOD'
	|";
	
	Запрос = СоздатьОбъект("ODBCRecordSet");

	глДобавитьФильтр(Запрос,ТекстЗапроса,"","$СпрН","Закупщик",ГруппаСотр,"Сотрудники");	
	Запрос.УстановитьТекстовыйПараметр("Нач",ДатаНачала);
	Запрос.УстановитьТекстовыйПараметр("Кон",ДатаКонца+1);
	Табл=Запрос.ВыполнитьИнструкцию(ТекстЗапроса);

	//Табл.ВыбратьСтроку();
	
	ЗагрузитьТабличнуюЧасть(Табл);
	
	
КонецПроцедуры
//Procedure Choice() //Stas
//	Режим="Каталог";
//	ОткрытьПодбор("Номенклатура","ДляПодбора");
//	УстановитьЗначениеВПодборе("Склад",Константа.ОсновнойСклад);
//	
//endProcedure

//********************************
Процедура Доступ()
	
КонецПроцедуры


Процедура ДобавитьСтроку( пТовар )
	НоваяСтрока();
	Товар = пТовар;
	ТовКод=Товар.Код;
КонецПроцедуры

//-----------------------------------------------
Процедура ОбработкаПодбора(Выб)
	Если Режим="Каталог" Тогда
		ВыбТовар=Выб;
	Иначе
		ВыбТовар=Выб.Товар;
	КонецЕсли;                 
	Если ПустоеЗначение(ВыбТовар)=1 Тогда
		Возврат;
	КонецЕсли;  
	Если ВыбТовар.ЭтоГруппа()=1 Тогда
		Если Вопрос("Добавить в табличную часть все элементы из группы "+выбТовар+"?","Да+Нет")="Нет" Тогда
			Возврат;
		КонецЕсли;
		Спр=СоздатьОбъект("Справочник.Номенклатура");
		Спр.ИспользоватьРодителя(Выбтовар.ТекущийЭлемент());
		Спр.ВыбратьЭлементы();
		Пока Спр.ПолучитьЭлемент()=1 Цикл
			Если Спр.ЭтоГруппа()=1 Тогда
				Продолжить;
			КонецЕсли;
			Если Спр.ПометкаУдаления()=1 Тогда
				Продолжить;
			КонецЕсли;
			ДобавитьСтроку(Спр.ТекущийЭлемент());
		КонецЦикла;
	Иначе
		ДобавитьСтроку(ВыбТовар.ТекущийЭлемент());
	КонецЕсли;
КонецПроцедуры


Процедура кнПечать()
	Если Модифицированность() = 1 Тогда
		Ответ = Вопрос("Документ не был записан после внесенных изменений. Записать?","Да+Нет",60);
		Если Ответ <> "Да" Тогда Возврат; КонецЕсли;
		Записать(); 
	КонецЕсли;

	таб = СоздатьОбъект( "Таблица" );
	таб.ИсходнаяТаблица( "Таблица" );
	таб.ВывестиСекцию( "Шапка" );
	таб.Опции( 0, 0, таб.ВысотаТаблицы(), 0 );
	
	итТовары=СоздатьОбъект("ИндексированнаяТаблица");
	итТовары.Загрузить(ТекущийДокумент());
	итТовары.Группировать("Товар : &*Товар","");
	итТовары.Сортировать("*Товар");
	ВывестиИТЗ(итТовары);
	
	//ВыбратьСтроки();
	//Ном=0;
	//Пока ПолучитьСтроку() = 1 Цикл
	//	//Количество=Рег.СводныйОстаток(Товар,,"ОстатокТовара");
	//	//РассчитатьПереоценку();
	//	Ном=Ном+1;
	//	Таб.ВывестиСекцию("Строка");
	//КонецЦикла;
	Таб.ПараметрыСтраницы(2,100,,,,,,,,1);
	Таб.ВывестиСекцию("Подвал");
	Таб.Опции(0,0,0,0);
	Таб.ТолькоПросмотр(0);
	Таб.Показать(Шаблон("Решение об изменении ассортимента [НомерДок]"),"");
КонецПроцедуры
//-----------------------------------------------
Процедура ВводНового(ФлКопирования);
	ЗаполнитьШапку(Контекст);
	
	ДатаДок=РабочаяДата();     
	
	ДатаНачала=НачНедели(ДатаДок);
	ДатаКонца=ДатаДок;

	УдалитьСтрокиДокумента(Контекст);
	//ДатаПереоценки=ДатаДок+1;
КонецПроцедуры

Процедура ПриОткрытии()
КонецПроцедуры

Процедура кнПодбор()
	Z_Подбор(Контекст,Режим);
КонецПроцедуры
//-----------------------------------------------
//Процедура ВернутьЦены()
//	ВыбратьСтроки();
//	Пока (ПолучитьСтроку()>0) Цикл
//		Цена=ПредЦена;
//		Переоценка=0;
//	КонецЦикла;
//КонецПроцедуры


//*****************************************************
//Начало текста, вставленного Инсталлятором МОД
Процедура ПриЗаписи() Далее
//Конец текста, вставленного Инсталлятором МОД
Процедура стар_ПриЗаписи()
	//Закомментировано Инсталлятором МОД:Процедура ПриЗаписи()
	Если семМожноЗаписать( Контекст ) = 0 Тогда Возврат; КонецЕсли;
	АвтоВремяНачалоДня();

	Если ПустоеЗначение(ДатаНачала)=1 Тогда
		Сообщить("Не выбрана начальная дата акции!");
		СтатусВозврата(0);
		Возврат;
	КонецЕсли;
	
	Если ДатаНачала>ДатаКонца Тогда
		Сообщить("Неверно задан дипазон акционного периода!");
		СтатусВозврата(0);
		Возврат;
	КонецЕсли;	
	
	
КонецПроцедуры
//Начало текста, вставленного Инсталлятором МОД
Процедура ПриЗаписи()
	//Внимание: данная процедура при обновлении Менеджера будет перезаписана заново
	//без сохранения текущего кода !!!
	//Рекомендуем собственные алгоритмы записывать в старую процедуру с префиксом стар_
	//	ПриИзмененииОбъекта(Контекст, ТекущийДокумент(), ДатаДок);
	стар_ПриЗаписи();
КонецПроцедуры
//Конец текста, вставленного Инсталлятором МОД


//-----------------------------------------------------
// При входе в Форму запомним промежуточные переменные
//Предупреждение ("При проведении документа Переоценка устанавливайте время документа на начало дня !!!");
Форма.КнопкаПоУмолчанию("Ok");
Доступ();
Форма.ГруппаСотр.ВыборГруппы(1);