Перем Режим;
//----------------------
Процедура ПриВводеСтроки()
	ПриВводеСтрокиДокумента(Контекст);
КонецПроцедуры

//-----------------------------------------------

Функция КонтрольОстаткаЛок(Докум,Тов,Коэффт)
	ОстатокТовара=Регистр.ОстаткиТоваров.СводныйОстаток(Тов,Склад,,"ОстатокТовара");
	Если НЕ(семРазрешитьПродаватьРезерв( контекст )=Да) Тогда
		Резерв=Регистр.РезервыТоваров.СводныйОстаток(Тов,,"РезервТовара");
		РезервПоСчету=0;
		Если Докум.Вид()="РасходнаяНакладная" Тогда
			Если Докум.ДокументОснование.Вид()="Счет" Тогда
				РезервПоСчету=Регистр.РезервыТоваров.Остаток(Тов,Докум.ДокументОснование,"РезервТовара");
			КонецЕсли;
		КонецЕсли;
		ПолныйОстаток=Регистр.ОстаткиТоваров.СводныйОстаток(Тов,,,"ОстатокТовара");
		СвободныйРесурс=ПолныйОстаток-Резерв+РезервПоСчету;
		Если СвободныйРесурс<0  Тогда
			СвободныйРесурс=0;
		КонецЕсли;
		Если СвободныйРесурс<ОстатокТовара Тогда
			ОстатокТовара=СвободныйРесурс;
		КонецЕсли;
	КонецЕсли;
	Если Коэффт>0 Тогда
		Возврат ОстатокТовара/Коэффт;
	Иначе
		Возврат 0;
	КонецЕсли;
КонецФункции

Процедура УстанКоличества()
	Если Товар.Выбран() >0 Тогда
		Если Количество=0 Тогда
			Количество=1;
		КонецЕсли;
		Коэффициент=0;
		Спр=СоздатьОбъект("Справочник.Единицы");
		Спр.ИспользоватьДату(ДатаДок);
		Спр.ИспользоватьВладельца(Товар);
		Спр.ВыбратьЭлементы();
		Пока Спр.ПолучитьЭлемент()>0 Цикл
			Если Спр.Единица=Товар.БазоваяЕдиницаИзмерения Тогда
				Единица=Спр.ТекущийЭлемент();
				Коэффициент=Спр.Коэффициент;
				Возврат;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры

Процедура ИзмЕдинЛок()
	Пром=Единица;
	Пром.ИспользоватьДату(ДатаДок);
	Коэффициент=Единица.Коэффициент;
КонецПроцедуры

Процедура Подбор()
	Режим="Каталог";
	ОткрытьПодбор("Номенклатура","ДляПодбора");
	УстановитьЗначениеВПодборе("Склад",СкладИсполнитель);
КонецПроцедуры



Процедура ОбработкаПодбора(Выб)
	Если Константа.ЗапрашиватьКоличество=Перечисление.Булево.Да Тогда
		Кол=1;
		Если ВвестиЧисло(Кол,"Введите количество",15,3)=1 Тогда
			НоваяСтрока();
			Если Режим="Каталог" Тогда
				Товар=Выб;
			Иначе
				Товар=Выб.Товар;
			КонецЕсли;
			Количество=Кол;
		Иначе
			Возврат;
		КонецЕсли;
	Иначе
		НоваяСтрока();
		Если Режим="Каталог" Тогда
			Товар=Выб;
		Иначе
			Товар=Выб.Товар;
		КонецЕсли;
		Количество=1;
	КонецЕсли;
	ИзмЕдинЛок();
	УстанКоличества();
	Остаток=КонтрольОстаткаЛок(ТекущийДокумент(),Товар,Коэффициент);
	АктивизироватьСтроку();
КонецПроцедуры

Процедура Печать()
	Таб=СоздатьОбъект("Таблица");   
	Таб.ИсходнаяТаблица("Требование");
	Таб.ВывестиСекцию("Шапка");
	ВыбратьСтроки();
	Ном=0;
	Пока ПолучитьСтроку() = 1 do  
		Если Количество<=0 Тогда
			Продолжить;
		КонецЕсли;	
		Ном=Ном+1;
		Таб.ВывестиСекцию("Товар");
	КонецЦикла;
	Таб.ВывестиСекцию("Итого");
	Таб.Защита(Константа.ФлагЗащитыТаблиц);
	Таб.ТолькоПросмотр(1);
	Таб.Опции(0,0,0,0,ПарСтрДок);
	Таб.Показать("Печать Заказа Кладовщику","");
КонецПроцедуры

Процедура ВводНового()
	ЗаполнитьШапку(Контекст);
	СкладИсполнитель=Константа.ОсновнойСклад;
	Заказчик=Автор;
	ДатаИсполнения=ДатаДок;
КонецПроцедуры  

Процедура ПриОткрытии()
	Если ПустоеЗначение(ДокументОснование)=0 Тогда
	Форма.ПодборПоКаталогу.Доступность(0);	
	КонецЕсли;	
КонецПроцедуры

Процедура ВводНаОсновании(ДокОснование)
	Если (ДокОснование.Вид()="Счет") ИЛИ
	(ДокОснование.Вид()="Перемещение") ИЛИ
	(ДокОснование.Вид()="РасходнаяНал") ИЛИ
	(ДокОснование.Вид()="ПриходнаяНал") ИЛИ
	(ДокОснование.Вид()="РасходнаяКредит") ИЛИ
	(ДокОснование.Вид()="ЗаказКладовщику") ИЛИ
	(ДокОснование.Вид()="ЗаказКалькуляция") ИЛИ
	(ДокОснование.Вид()="ПриходнаяКредит") ИЛИ
	(ДокОснование.Вид()="РасходнаяРеализ") ИЛИ
	(ДокОснование.Вид()="ПриходнаяРеализ") Тогда
		Если СокрП(НомерДок)="" Тогда
			НомерДок="Зкл-00001";
		КонецЕсли;
		ДатаДок=РабочаяДата();
		Автор=Пользователь;     
		Фирма=ДокОснование.Фирма;
		Если (ДокОснование.Вид()="Счет") Тогда
			Склад=Константа.ОсновнойСклад;
		ИначеЕсли   (ДокОснование.Вид()="ЗаказКладовщику")  Тогда
			Склад=ДокОснование.СкладИсполнитель;
			СкладПолучатель=ДокОснование.СкладЗаказчик;
		Иначе
			Склад=ДокОснование.Склад;
		КонецЕсли;
		СкладПолучатель=Константа.ОсновнойСклад;
		Если (ДокОснование.Вид()="Перемещение") Тогда
			Основание=ДокОснование.Вид()+" № " + ДокОснование.НомерДок + " от " + ДокОснование.ДатаДок;
			СкладИсполнитель=ДокОснование.Склад;
			СкладЗаказчик=ДокОснование.СкладПолучатель;
		КонецЕсли;
		ДокОснование.ВыбратьСтроки();
		Пока ДокОснование.ПолучитьСтроку()=1 Цикл
			НоваяСтрока();
			Товар=ДокОснование.Товар;
			Единица=ДокОснование.Единица;
			Коэффициент=ДокОснование.Коэффициент;
			Количество=ДокОснование.Количество;
		КонецЦикла;
	Иначе
		Предупреждение("Накладную перемещения нельзя вводить на основании выбранного вида документа!!!");
		СтатусВозврата(0);
	КонецЕсли;
КонецПроцедуры

Процедура ОткрытьДО()
	ОткрытьФорму(ДокументОснование.ТекущийДокумент(),,1);
КонецПроцедуры
//
Процедура Скоректировать()
	ВыбратьСтроки();
	Пока ПолучитьСтроку()=1 Цикл
		Если Число(Остаток)>Число(Количество)  Тогда
			Количество=0;
		Иначе
			Количество=Количество-Остаток;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры
//-----------------------------------------------
Процедура ОкруглитьДоЦелыхДД()
	ВыбратьСтроки();
	Пока ПолучитьСтроку()=1 Цикл
		Если Товар.ОкруглятьДоЦелых=Перечисление.Булево.НЕТ Тогда
			Продолжить;
		Иначе
			СпрЕд=СоздатьОбъект("Справочник.Единицы");
			СпрЕд.ИспользоватьВладельца(Товар);
			СпрЕд.НаитиЭлемент(Товар.БазоваяЕдиницаИзмерения);
			ЕдИзмер=СпрЕд.ТекущийЭлемент();
			Если Единица=ЕдИзмер Тогда
				Количест=Окр(Количество,0,1);
				Если Количест<Количество Тогда
					Количество=Количест+1;
				Иначе
					Количество=Количест;
				КонецЕсли;
			Иначе
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Процедура ОкруглитьДоЦелых()
	ВыбратьСтроки();
	Пока ПолучитьСтроку()=1 Цикл
		Если НЕ(Единица.ОкруглятьДоЦелых=Перечисление.Булево.Да) Тогда
			Продолжить;
		Иначе
			Количест=Окр(Количество,0,1);
			Если Количест<Количество Тогда
				Количество=Количест+1;
			Иначе
				Количество=Количест;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры
//Начало текста, вставленного Инсталлятором МОД
Процедура ПриЗаписи()
	//Внимание: данная процедура при обновлении Менеджера будет перезаписана заново
	//без сохранения текущего кода !!!
	//Рекомендуем собственные алгоритмы записывать в старую процедуру с префиксом стар_
	ПриИзмененииОбъекта(Контекст, ТекущийДокумент(), ДатаДок);
	Если семМожноЗаписать( Контекст ) = 0 Тогда Возврат; КонецЕсли;
КонецПроцедуры
//Конец текста, вставленного Инсталлятором МОД
