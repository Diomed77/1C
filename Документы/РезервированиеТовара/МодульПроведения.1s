//Начало текста, вставленного Инсталлятором МОД
Процедура ОбработкаПроведения() Далее
//Конец текста, вставленного Инсталлятором МОД
Процедура стар_ОбработкаПроведения()
//Закомментировано Инсталлятором МОД:Процедура ОбработкаПроведения() 
	Если семМожноПровести( Контекст ) = 0 Тогда Возврат; КонецЕсли;
	//Если ДатаДок>ТекущаяДата() Тогда
	//	НеПроводить(Контекст,"Нельзя проводить документ будущей датой!");
	//	Возврат;
	//КонецЕсли;
    Если ПроверкаДублейСтрок(Контекст)=1 Тогда 
		Сообщить("В документе строки с одинаковым товаром!");
		Возврат;
	КонецЕсли;    

	РегЗаказы=СоздатьОбъект("Регистр.ЗаказыПокупателей");
	РегОстатки=СоздатьОбъект("Регистр.ОстаткиТоваров");
    Если ИтогиАктуальны()=0  Тогда
    	РегЗаказы.ВременныйРасчет(1);                  
		РегОстатки.ВременныйРасчет(1);
        РассчитатьРегистрыНа(ТекущийДокумент());
	КонецЕсли;  
	
	Регистр.ЗаказыПокупателей.Клиент=Клиент;
	Регистр.ЗаказыПокупателей.СрокПоставки=ДатаПоставки;
	Регистр.ЗаказыПокупателей.ПоЗаказу=ДокументОснование;

	Регистр.РезервыТоваров.ПоСчету=ДокументОснование;

	ВыбратьСтроки();
	Пока ПолучитьСтроку()=1 Цикл
		КолНаСкладе=РегОстатки.СводныйОстаток(Товар,Склад,,"ОстатокТовара");
		КолРезерв=РегЗаказы.Остаток(Товар,Клиент,ДатаПоставки,ДокументОснование,"Резервировать");
		КолВозм=Мин(КолНаСкладе,КолРезерв);
		Колво=Количество*Коэффициент;
		КолПогаш=Мин(Колво,КолВозм);
		Если КолПогаш<Колво Тогда // если нельзя зарезервировать все количество 
			Сообщить("По товару "+Товар.Наименование+" нельзя зарезервировать требуемое количество "+Колво+Товар.БазоваяЕдиницаИзмерения+":
			|план по резерву = "+КолРезерв+",
			|остаток на складе = "+КолНаСкладе+",
			|можно зарезервировать "+КолПогаш,"!");                                 		    
			СтатусВозврата(0);
			Возврат;
		КонецЕсли;		
		
		Регистр.ЗаказыПокупателей.Товар=Товар;
		Регистр.ЗаказыПокупателей.Резервировать=КолПогаш;
		Регистр.ЗаказыПокупателей.ДвижениеРасходВыполнить();
		
		Регистр.РезервыТоваров.Товар=Товар;
		Регистр.РезервыТоваров.РезервТовара=КолПогаш;
		Регистр.РезервыТоваров.ДвижениеПриходВыполнить();
	КонецЦикла;
	
КонецПроцедуры
//Начало текста, вставленного Инсталлятором МОД
Процедура ОбработкаПроведения()
	//Внимание: данная процедура при обновлении Менеджера будет перезаписана заново
	//без сохранения текущего кода !!!
	//Рекомендуем собственные алгоритмы записывать в старую процедуру с префиксом стар_
	Если ПроведениеМОД(Контекст)=1 Тогда
	    Возврат;
	КонецЕсли;
	стар_ОбработкаПроведения();
КонецПроцедуры
//Конец текста, вставленного Инсталлятором МОД
//Начало текста, вставленного Инсталлятором МОД
Процедура ОбработкаУдаленияПроведения()
	//Внимание: данная процедура при обновлении Менеджера будет перезаписана заново
	//без сохранения текущего кода !!!
	//Рекомендуем собственные алгоритмы записывать в старую процедуру с префиксом стар_
	Если ПроведениеПоАлгоритмуМОД=1 Тогда
	    Возврат;
	КонецЕсли;
	ПриИзмененииОбъекта(Контекст, ТекущийДокумент(), ДатаДок);
КонецПроцедуры
//Конец текста, вставленного Инсталлятором МОД

