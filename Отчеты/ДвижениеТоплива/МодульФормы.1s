Перем спр;

Процедура ВводВТаблице()
	текСтрока = табл.ТекущаяСтрока();
	текКолонка = табл.ТекущаяКолонка();
	Если текКолонка = "Сумма" Тогда
		зн = табл.ПолучитьЗначение(текСтрока,текКолонка);
		Если ВвестиЧисло(зн,"Сумма",12,2)=1 Тогда
			табл.УстановитьЗначение(текСтрока,текКолонка,зн);
		КонецЕсли;
	ИначеЕсли текКолонка = "Литры" Тогда
		зн = табл.ПолучитьЗначение(текСтрока,текКолонка);
		Если ВвестиЧисло(зн,"Литры",10,3)=1 Тогда
			табл.УстановитьЗначение(текСтрока,текКолонка,зн);
		КонецЕсли;
	ИначеЕсли текКолонка = "СуммаДр" Тогда
		зн = табл.ПолучитьЗначение(текСтрока,текКолонка);
		Если ВвестиЧисло(зн,"Др.расх.",12,2)=1 Тогда
			табл.УстановитьЗначение(текСтрока,текКолонка,зн);
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Процедура Сформировать()
	начЛог = семЗаписатьЛогНач( "Отчет", "Движение топлива", "Обработка", "Формирование отчета" );
	спр.ВыбратьЭлементы();
	
	ЗапросПоТопливу = СоздатьОбъект( "Запрос" );
	ТекстЗапроса = "
	|ОбрабатыватьДокументы Проведенные;
	|ДатаДок = Документ.МаршрутныйЛист.ДатаДок;
	|Машина = Документ.МаршрутныйЛист.Машина;
	|Топливо = Документ.МаршрутныйЛист.Топливо;
	|МоторЧасы = Документ.МаршрутныйЛист.МоторЧасы;
	|Функция фТопливоНач = Сумма( Топливо ) когда (ДатаДок < ДатаС);
	|Функция фТопливоКон = Сумма( Топливо ) когда (ДатаДок <= ДатаПо);
	|Функция фМоторЧасыНач = Сумма( МоторЧасы ) когда (ДатаДок < ДатаС);
	|Функция фМоторЧасыКон = Сумма( МоторЧасы ) когда (ДатаДок <= ДатаПо);
	|Группировка Машина;";
	Если ЗапросПоТопливу.Выполнить( ТекстЗапроса ) = 0 Тогда
		Сообщить( "Запрос не выполнился", "!" );
		Возврат;
	КонецЕсли;
    
	//табл = СоздатьОбъект( "ТаблицаЗначений" );
	//ЗапросПоТопливу.Выгрузить(табл,1);
	//табл.ВыбратьСтроку(); возврат;
	
	таб = СоздатьОбъект( "Таблица" );
	таб.ИсходнаяТаблица( "ТаблицаЛат" );
	таб.ВывестиСекцию( "Заголовок" );		
	таб.ВывестиСекцию( "Шапка" );		
	таб.Опции( 0, 0, таб.ВысотаТаблицы(), 0 );
	пВалюта = Константа.БазоваяВалюта;
	пНом = 0;
	пИтогРасх = 0;
	пИтогРасхД = 0;
	пИтогРасхП = 0;
	пИтогРасхПД = 0;
	пИтогРасхС = 0;
	пИтогРасхСД = 0;
	пИтогРасхДр = 0;
	Пока спр.ПолучитьЭлемент() = 1 Цикл  
		Если Спр.ПометкаУдаления()=1 Тогда
			Продолжить;
		КонецЕсли;
		НомСтр = 0;
		Если табл.НайтиЗначение(спр.ТекущийЭлемент(),НомСтр,"Машина") = 1 Тогда
			Литры = табл.ПолучитьЗначение(НомСтр,"Литры");
			Сумма = табл.ПолучитьЗначение(НомСтр,"Сумма");
			СуммаДр = табл.ПолучитьЗначение(НомСтр,"СуммаДр");
			Цена = ?(Литры<>0,Сумма/Литры,0);
		КонецЕсли;
		пНом = пНом + 1;
		Машина = спр.ТекущийЭлемент();
		пВодитель = спр.Шофер1;
		пМашина = спр.Марка;
		пНомер = спр.Код;
		пКарт = спр.НомерКарты;
		пТипТопл = ?(спр.ТипДвигателя = 1,"B","D");
		пРасхТопл = спр.РасходТоплива+"л.";
		пРасхМотор = спр.РасходТопливаМ+"л.";
		
		пСпидНач = спр.Пробег.Получить(ДатаС-1);
		пСпидКон = спр.Пробег.Получить(ДатаПо);
		пСпид = пСпидКон-пСпидНач;
		
		пМоторНач = ?(ЗапросПоТопливу.Получить(спр.ТекущийЭлемент())=1,ЗапросПоТопливу.фМоторЧасыНач,0);
		пМоторКон = ?(ЗапросПоТопливу.Получить(спр.ТекущийЭлемент())=1,ЗапросПоТопливу.фМоторЧасыКон,0);
		пМотор = пМоторКон - пМоторНач;
		
		начРасходПоКм = пСпидНач*пРасхТопл/100;
		начРасходПоМ = пМоторНач*пРасхМотор;
		пРасхНач = ?(ЗапросПоТопливу.Получить(спр.ТекущийЭлемент())=1,ЗапросПоТопливу.фТопливоНач,0)-начРасходПоКм-начРасходПоМ;
		пРасхНачД = пРасхНач*Цена;

		конРасходПоКм = пСпидКон*пРасхТопл/100;
		конРасходПоМ = пМоторКон*пРасхМотор;
		пРасхКон = ?(ЗапросПоТопливу.Получить(спр.ТекущийЭлемент())=1,ЗапросПоТопливу.фТопливоКон,0)-конРасходПоКм-конРасходПоМ;
		пРасхКонД = пРасхКон*Цена;
		
		пРасх = ?(ЗапросПоТопливу.Получить(спр.ТекущийЭлемент())=1,ЗапросПоТопливу.фТопливоКон,0) - ?(ЗапросПоТопливу.Получить(спр.ТекущийЭлемент())=1,ЗапросПоТопливу.фТопливоНач,0);
		пРасхД = пРасх*Цена;
		
		пРасхП = конРасходПоКм+конРасходПоМ-начРасходПоКм-начРасходПоМ;
		пРасхПД = пРасхП*Цена;
		пРасхС = Литры;
		пРасхСД = Сумма;
		пРасхДр = СуммаДр; 
		
		пИтогРасх = пИтогРасх + пРасх;
		пИтогРасхД = пИтогРасхД + пРасхД;
		пИтогРасхП = пИтогРасхП + пРасхП;
		пИтогРасхПД = пИтогРасхПД + пРасхПД;
		пИтогРасхС = пИтогРасхС + пРасхС;
		пИтогРасхСД = пИтогРасхСД + пРасхСД;
		пИтогРасхДр = пИтогРасхДр + пРасхДр;
		
		таб.ВывестиСекцию( "Строка" );		
	КонецЦикла;
	таб.ВывестиСекцию( "Итог" );		
	таб.ТолькоПросмотр( 1 );
	таб.Показать( "Движение топлива" );	
	семЗаписатьЛогКон( начЛог );	
КонецПроцедуры

Процедура ПроверкаПрав()
	спПрав = СоздатьОбъект( "СписокЗначений" );
	спПрав.ДобавитьЗначение("Администратор");
	спПрав.ДобавитьЗначение("РуководительЛогистики");
	спПрав.ДобавитьЗначение("Просмотр");
	Если спПрав.НайтиЗначение( НазваниеНабораПрав() ) = 0 Тогда
		Предупреждение( "Нет прав." );
		СтатусВозврата( 0 );
	КонецЕсли;
КонецПроцедуры

Процедура ПриОткрытии()
	//ПроверкаПрав();
	табл.НоваяКолонка("Машина","Справочник.Автотранспорт",,,"Машина",30);
	табл.НоваяКолонка("Карта","Строка",10,,"Карта",10);
	табл.НоваяКолонка("Литры","Число",10,3,"Литры",10);
	табл.НоваяКолонка("Сумма","Число",12,2,"Сумма",10);
	табл.НоваяКолонка("СуммаДр","Число",12,2,"Др.расх.",10);
	спр.ВыбратьЭлементы();
	Пока спр.ПолучитьЭлемент() = 1 Цикл
		табл.НоваяСтрока();
		табл.Машина = спр.ТекущийЭлемент();
		табл.Карта = спр.НомерКарты;
		табл.Литры = 0;
		табл.Сумма = 0;
		табл.СуммаДр = 0;
	КонецЦикла;
КонецПроцедуры

спр = СоздатьОбъект( "Справочник.Автотранспорт" );
