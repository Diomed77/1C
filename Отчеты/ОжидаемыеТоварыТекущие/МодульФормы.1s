
Перем Сводная, КонструкторЗапросов, ВремПапка;
Перем гРФорма, гРасшФорма;
Перем Окна, ФормаРасш;
Перем ТекШирина, ТекВысота;
Перем КоммВерсия;
Перем ФайлКуба;

Перем ДатаОтчета1;
Перем ДатаСрока;

Функция ПолучитьСправочник(Сост)
	спрСост=СоздатьОбъект("Справочник.Страны");
	спрСост.НайтиПоКоду(Сост,0);
	Возврат спрСост.ТекущийЭлемент();
КонецФункции

Функция ЗагрузкаИТ(Подтверждено,НачПериода,КонПериода)
	ИТ=СоздатьОбъект("ИндексированнаяТаблица");
	Запрос=СоздатьОбъект("ODBCRecordSet");
//	спр=СоздатьОбъект("Справочник.Пользователи");
	текст="";
	Если Подтверждено=1 Тогда
		текст="AND ((Журнал.CLOSED & 1) = 1)";
		текст=текст+"AND ($ОжидаемаяПоставка.ПодписьЛогиста <> $ПустойИД)";
	Иначе
		текст="";
	КонецЕсли;
	

	спрЛатвия=ПолучитьСправочник("LV");

		Если чВидСтраны=1 Тогда
			текст=текст+"AND ($Контрагенты.Страна = :пСтрана)";
			Запрос.УстановитьТекстовыйПараметр("пСтрана",спрЛатвия);
		ИначеЕсли чВидСтраны=2 Тогда
			текст=текст+"AND ($Контрагенты.Страна <> :пСтрана)";
			Запрос.УстановитьТекстовыйПараметр("пСтрана",спрЛатвия);
		КонецЕсли;
	
	Если выбПоставщик.Выбран() = 1 Тогда
		Если выбПоставщик.ЭтоГруппа() = 1 Тогда 
			текст = текст + " AND $ОжидаемаяПоставка.Клиент IN (SELECT Val FROM #Клиент)";
			Запрос.УложитьСписокОбъектов(выбПоставщик,"#Клиент","Контрагенты");
		Иначе 
			текст = текст + " AND $ОжидаемаяПоставка.Клиент = :ВыбПоставщик";
			Запрос.УстановитьТекстовыйПараметр("ВыбПоставщик",выбПоставщик);
		КонецЕсли;
	КонецЕсли;		

	Если выбЗакупщик.Выбран() = 1 Тогда

			текст = текст + " AND $ОжидаемаяПоставка.ПодписьМенеджера = :выбЗакупщик";
			Запрос.УстановитьТекстовыйПараметр("выбЗакупщик",выбЗакупщик);

	КонецЕсли;	
	
	Если выбАгент.Выбран() = 1 Тогда
		Если выбАгент.ЭтоГруппа() = 1 Тогда 
			текст = текст + " AND $ОжидаемаяПоставка.Агент IN (SELECT Val FROM #Агент)";
			Запрос.УложитьСписокОбъектов(выбАгент,"#Агент","Сотрудники");
		Иначе 
			текст = текст + " AND $ОжидаемаяПоставка.Агент = :выбАгент";
			Запрос.УстановитьТекстовыйПараметр("выбАгент",выбАгент);
		КонецЕсли;
	КонецЕсли;		
	
	Если ВыбСклад.Выбран() = 1 Тогда
		Если ВыбСклад.ЭтоГруппа() = 1 Тогда 
			текст = текст + " AND ОжидаемаяПоставка.IDDOC IN (SELECT Док.IDDOC
			|											  FROM $ДокументСтроки.ОжидаемаяПоставка Док (NOLOCK) 
			|											  INNER JOIN $Документ.ОжидаемаяПоставка AS ОжидаемаяПоставка With (NOLOCK) ON ОжидаемаяПоставка.IDDOC = Док.IDDOC
			|						 					  INNER JOIN $Справочник.СкладскиеАдреса AS СкладскиеАдреса With (NOLOCK) ON $СкладскиеАдреса.Товар = $Док.Товар
			|											  INNER JOIN Дерево_СкладскиеАдреса ДСА (NOLOCK) ON ДСА.ID = СкладскиеАдреса.ID 
			|											  INNER JOIN $Справочник.СкладскиеАдреса СпрСАГ (NOLOCK) ON ДСА.PARENTID = СпрСАГ.ID AND СпрСАГ.ISFOLDER = 1 AND $СпрСАГ.УровеньИерархии = 0
			|											  WHERE $СпрСАГ.Склад IN (SELECT Val FROM #Склады) 
			|											  AND $ОжидаемаяПоставка.ДатаПрихода >= :НачПериода
			|											  AND $ОжидаемаяПоставка.ДатаПрихода <= :КонПериода)
			|";
			Запрос.УложитьСписокОбъектов(ВыбСклад,"#Склады","МестаХранения");
			Запрос.УстановитьТекстовыйПараметр("НачПериода",НачПериода);
			Запрос.УстановитьТекстовыйПараметр("КонПериода",КонПериода);

		Иначе 
			текст = текст + " AND ОжидаемаяПоставка.IDDOC IN (SELECT Док.IDDOC
			|											  FROM $ДокументСтроки.ОжидаемаяПоставка Док (NOLOCK) 
			|											  INNER JOIN $Документ.ОжидаемаяПоставка AS ОжидаемаяПоставка With (NOLOCK) ON ОжидаемаяПоставка.IDDOC = Док.IDDOC
			|						 					  INNER JOIN $Справочник.СкладскиеАдреса AS СкладскиеАдреса With (NOLOCK) ON $СкладскиеАдреса.Товар = $Док.Товар
			|											  INNER JOIN Дерево_СкладскиеАдреса ДСА (NOLOCK) ON ДСА.ID = СкладскиеАдреса.ID 
			|											  INNER JOIN $Справочник.СкладскиеАдреса СпрСАГ (NOLOCK) ON ДСА.PARENTID = СпрСАГ.ID AND СпрСАГ.ISFOLDER = 1 AND $СпрСАГ.УровеньИерархии = 0
			|											  WHERE $СпрСАГ.Склад = :ВыбСклад
			|											  AND $ОжидаемаяПоставка.ДатаПрихода >= :НачПериода
			|											  AND $ОжидаемаяПоставка.ДатаПрихода <= :КонПериода )
			|";
			Запрос.УстановитьТекстовыйПараметр("ВыбСклад",ВыбСклад);
		КонецЕсли;
	КонецЕсли;		
	
	
	ТекстЗапроса="SELECT $ОжидаемаяПоставка.Клиент [Клиент $Справочник.Контрагенты]
		|	, $Контрагенты.Страна [Страна $Справочник.Страны]
		|	, $ОжидаемаяПоставка.ВидГруза ВидГруза
		|	, $ОжидаемаяПоставка.СуммаПодтв СуммаПодтв
		|	, $ОжидаемаяПоставка.трПалет18 трПалет18
		|	, $ОжидаемаяПоставка.трПалет2 трПалет2
		|	, $ОжидаемаяПоставка.трПалет25 трПалет25		
		|	, $ОжидаемаяПоставка.НеделяПрихода НеделяПрихода
		|	, $Контрагенты.Агент [КонтрагентыАгент $Справочник.Сотрудники]
		|	, NullIf($ОжидаемаяПоставка.ДатаПрихода, '17530101') ДатаПрихода
		|	, ОжидаемаяПоставка.IDDOC [Док $Документ.ОжидаемаяПоставка]
		|FROM $Документ.ОжидаемаяПоставка AS ОжидаемаяПоставка With (NOLOCK)
		|	LEFT OUTER JOIN $Справочник.Контрагенты AS Контрагенты With (NOLOCK) ON $ОжидаемаяПоставка.Клиент = Контрагенты.ID
		|	LEFT OUTER JOIN _1SJOURN AS Журнал With (NOLOCK) ON ОжидаемаяПоставка.IDDOC = Журнал.IDDOC
		|WHERE ($ОжидаемаяПоставка.ДатаПрихода >= :НачПериода)
		|	AND ($ОжидаемаяПоставка.ДатаПрихода <= :КонПериода)
		|	AND ($ОжидаемаяПоставка.СуммаПодтв > 0)
		|	"+текст+"
		|";	
	
	
	Запрос.УстановитьТекстовыйПараметр("НачПериода",НачПериода);
	Запрос.УстановитьТекстовыйПараметр("КонПериода",КонПериода);
	Запрос.ВыполнитьИнструкцию(ТекстЗапроса,ИТ);
	//пДок.ДобавитьИндекс("иПоЗаказу","ПоЗаказу");
	Возврат ИТ;
КонецФункции

Функция ПоискФайлов(п_Док)
	ИТ=СоздатьОбъект("ИндексированнаяТаблица");
	Запрос=СоздатьОбъект("ODBCRecordSet");
	
	ТекстЗапроса="SELECT ФайлДок.ID [Ссылка $Справочник.ФайлДок]
		|	, ФайлДок.DESCR Наименование
		|	, $ФайлДок.Файл Файл
		|	, $ФайлДок.ВидФайла [ВидФайла $Перечисление.ВидыФайлов]
		|	, NullIf($ФайлДок.ДатаФайла, '17530101') ДатаФайла
		|	, $ФайлДок.Автор [Автор $Справочник.Пользователи]
		|FROM $Справочник.ФайлДок AS ФайлДок With (NOLOCK)
		|WHERE ($ФайлДок.Док =$ВидДокумента36.ОжидаемаяПоставка + :Док)
		|";	

	Запрос.УстановитьТекстовыйПараметр("Док",п_Док);
	Запрос.ВыполнитьИнструкцию(ТекстЗапроса,ИТ);
	Возврат ИТ;
КонецФункции

Процедура Сформировать()
	Перем Запрос, ТекстЗапроса, Таб;
	
	Если фЗакупка=1 Тогда
		п_НачПер=ВыбНачПериода;
		ВыбКонПериода=п_НачПер+6;
	КонецЕсли;	
	
	ИТ=ЗагрузкаИТ(фТолькоПроведенные,ВыбНачПериода,ВыбКонПериода);

	Таб = СоздатьОбъект("Таблица");

	Если фЗакупка=1 Тогда
		Таб.ИсходнаяТаблица("ДляЗакупки");	
	Иначе
		Таб.ИсходнаяТаблица("Сформировать");
	КонецЕсли;

	// Заполнение полей "Заголовок"
	п_Поставщик=?(ПустоеЗначение(выбПоставщик)=0,выбПоставщик,"Пусто");
	п_Агент=?(ПустоеЗначение(выбАгент)=0,выбАгент,"Пусто");
	п_Закупщик=?(ПустоеЗначение(выбЗакупщик)=0,выбЗакупщик,"Пусто");
	
	Если чВидСтраны=1 Тогда
		п_ВидСтраны="Латвия";
	ИначеЕсли чВидСтраны=2 Тогда
		п_ВидСтраны="Зарубеж";
	Иначе
		п_ВидСтраны="Все";
	КонецЕсли;	
	
	
	Если чНаличиеПрихода=1 Тогда
		п_НаличиеПрихода="Есть";
	ИначеЕсли чНаличиеПрихода=2 Тогда
		п_НаличиеПрихода="Нет";
	ИначеЕсли чНаличиеПрихода=3 Тогда	
		п_НаличиеПрихода="Все";
	КонецЕсли;
	
	Таб.ВывестиСекцию("Заголовок");
	Состояние("Заполнение выходной таблицы...");
	Таб.Опции(0, 0, Таб.ВысотаТаблицы(), 0);
	пНомер=0;
	п_Сумма=0;
	
	ИТ.Сортировать("Клиент");

	ИТ.ВыбратьСтроки();
	Пока ИТ.ПолучитьСтроку() = 1 Цикл
		
		
		
		п_СостЛог="";
		п_СостЗак="";
		Если ПустоеЗначение(Ит.Док.ПодписьЛогиста)=0 Тогда
			п_СостЛог="Х";
			п_СостЗак="Х";
		КонецЕсли;
		
		Если ПустоеЗначение(Ит.Док.ПодписьМенеджера)=0 Тогда
			п_СостЗак="Х";
			
			СостояниеДок="";
			Если чНаличиеПрихода=1 Тогда
				СостояниеДок=глПолучитьСостояниеДокумента(Ит.Док);
				Если ПустоеЗначение(СостояниеДок)=0 Тогда
					Продолжить;
				КонецЕсли;
			ИначеЕсли чНаличиеПрихода=2 Тогда
				СостояниеДок=глПолучитьСостояниеДокумента(Ит.Док);
				Если ПустоеЗначение(СостояниеДок)=1 Тогда
					Продолжить;
				КонецЕсли;
			ИначеЕсли чНаличиеПрихода=3 Тогда	
			КонецЕсли;
		КонецЕсли;
		
	//Получение данных о наличия файлов в ож поставке
		л_списокФайлов=ПоискФайлов(Ит.Док);
	//	л_списокФайлов.Показать();

		яч_Proforma="";
		яч_Invoice="";
		яч_CMR="";
		яч_Pdf="";
	
		Если л_списокФайлов.КоличествоСтрок()>0 Тогда
			л_списокФайлов.ВыбратьСтроки();
			Пока л_списокФайлов.ПолучитьСтроку() = 1 Цикл			
				Если л_списокФайлов.ВидФайла=Перечисление.ВидыФайлов.Proforma Тогда
					яч_Proforma=л_списокФайлов.ДатаФайла;
				ИначеЕсли л_списокФайлов.ВидФайла=Перечисление.ВидыФайлов.Invoice Тогда
					яч_Invoice=л_списокФайлов.ДатаФайла;
				ИначеЕсли л_списокФайлов.ВидФайла=Перечисление.ВидыФайлов.CMR Тогда
					яч_CMR=л_списокФайлов.ДатаФайла;
				Иначе
					яч_Pdf=л_списокФайлов.ДатаФайла;
				КонецЕсли;
			КонецЦикла;	
		КонецЕсли;	
	//Получение данных о наличия файлов в ож поставке	
		пНомер=пНомер+1;	
		п_Сумма=п_Сумма+Ит.Док.Итог("СуммаПодтв");
		Таб.ВывестиСекцию("Счет");
	КонецЦикла;

	Таб.ВывестиСекцию("Итого");
//	Сообщить(п_Сумма);
	
	// Вывод заполненной формы
	Таб.ТолькоПросмотр(1);
	Таб.Показать("Сформировать", "");
КонецПроцедуры  

ВыбНачПериода=РабочаяДата();
ВыбКонПериода=РабочаяДата();
чВидСтраны=3;
чНаличиеПрихода=2;
