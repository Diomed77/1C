//*******************************************
Процедура Сформировать()

КонецПроцедуры  

//*******************************************
// Процедура генерации запроса СпецЦены.
//
Процедура СпецЦены()
	Перем Запрос, ТекстЗапроса, Таб;
	начЛог = семЗаписатьЛогНач( "Отчет", "Скидки клиентов", "Обработка", "Формирование отчета" );
	//Создание объекта типа Запрос
	Запрос = СоздатьОбъект("Запрос");
	ТекстЗапроса = 
	"//{{ЗАПРОС(СпецЦены)
	|Клиент = Справочник.КлиентСкидки.Владелец;
	|Товар = Справочник.КлиентСкидки.ТовГруппа;
	|КатегорияЦены = Справочник.КлиентСкидки.КатегорияЦены;
	|Скидка = Справочник.КлиентСкидки.ПроцентСкидки;
	|Группировка Клиент без групп;
	|Группировка Товар без групп;
	|"//}}ЗАПРОС
	;
	
	Заг="";
	Если ВыбКлиент.Выбран()=0 Тогда
	ИначеЕсли ВыбКлиент.ЭтоГруппа()=1 Тогда
		ТекстЗапроса=ТекстЗапроса+"Условие(Клиент в ВыбКлиент);";
		Заг="Для группы клиентов "+ВыбКлиент.Наименование;
	Иначе
		ТекстЗапроса=ТекстЗапроса+"Условие(Клиент = ВыбКлиент);";
		Заг="Для клиента "+ВыбКлиент.Наименование;
	КонецЕсли;

	Если выбКатегорияЦены.Выбран()=1 Тогда
		ТекстЗапроса=ТекстЗапроса+"Условие(КатегорияЦены = выбКатегорияЦены);";
		Заг2="Для категории цен "+выбКатегорияЦены;
	Иначе
		Сообщить("Ошибка формирования отчета!","!");
		Сообщить("Не выбрана категория цены.","I");
		Возврат;
	КонецЕсли;

	// Если ошибка в запросе, то выход из процедуры
	Если Запрос.Выполнить(ТекстЗапроса) = 0 Тогда
		Возврат;
	КонецЕсли;

	// Подготовка к заполнению выходных форм данными запроса
	Таб = СоздатьОбъект("Таблица");
	Таб.ИсходнаяТаблица("СпецЦены");
	// Заполнение полей "Заголовок"
	Таб.ВывестиСекцию("Заголовок");
	Состояние("Заполнение выходной таблицы...");
	Таб.Опции(0, 0, Таб.ВысотаТаблицы(), 0);
	Пока Запрос.Группировка(1) = 1 Цикл
		                      
		// Заполнение полей Клиент
		Таб.ВывестиСекцию("Клиент");
		Пока Запрос.Группировка(2) = 1 Цикл
			// Заполнение полей Товар
			Тов=Запрос.Товар;
			
			Тов.ИспользоватьДату(РабочаяДата());
			            
			цена=0;
			
			Цена = ЦенаТовараПоКатегорииДляТовара(Тов,выбКатегорияЦены,,РабочаяДата());
			
			СпецЦена=Окр(Цена*(100-Число(Запрос.Скидка))/100,2);
			Таб.ВывестиСекцию("Товар");      

		КонецЦикла;
	КонецЦикла;
	// Вывод заполненной формы
	Таб.ТолькоПросмотр(1);

	Таб.Показать("СпецЦены", "");
	семЗаписатьЛогКон( начЛог );	
КонецПроцедуры

