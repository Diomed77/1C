Перем Клиенты_;

//*******************************************
Процедура Сформировать()

КонецПроцедуры  

//{{БУХГАЛТЕРСКИЙ ЗАПРОС(ЗаНаличные)

//Данный фрагмент построен конструктором.
//При повторном использовании конструктора, внесенные вручную изменения будут потеряны!!!

//{{ Схема номер 6
//{{ ДтКт 1111110


Процедура ЗаНаличные()
	Таб = СоздатьОбъект("Таблица");
	Таб.ИсходнаяТаблица("ЗаНаличные");
	Ит = СоздатьОбъект("БухгалтерскиеИтоги");          
	
	СчетаКорр=Константа.Счет_ОснДебиторНЕРезидент.Код+","+Константа.Счет_ОснДебиторРезидент.Код+","+
			  Константа.Счет_ПрочДебиторНЕРезидент.Код+","+Константа.Счет_ПрочДебиторРезидент.Код+","+
			  Константа.Счет_ПолАвНЕРезидент.Код+","+Константа.Счет_ПолАвРезидент.Код+","+Константа.Счет_ПолГарант.Код;

	спр=СоздатьОбъект("Справочник.Кассы");
	
	спр.ВыбратьЭлементыПоРеквизиту("РознТорговля",Нет,0);

	Таб.ВывестиСекцию("Заголовок");
    
	Клиенты_.УдалитьСтроки();
	
	Пока Спр.ПолучитьЭлемент()=1 Цикл
		Ит.ИспользоватьКорСубконто(ВидыСубконто.Клиенты,, 1);
		Ит.ИспользоватьСубконто(ВидыСубконто.Кассы,Спр.ТекущийЭлемент(),2);

		Ит.ВыполнитьЗапрос(ВыбНачПериода, ВыбКонПериода, Константа.Счет_КассовыйАппарат, СчетаКорр,, 2,, "СВ");
	
		Таб.Опции(0,0,Таб.ВысотаТаблицы(),0);
		Ит.ВыбратьКорСубконто(ВидыСубконто.Клиенты);
		Пока Ит.ПолучитьКорСубконто(ВидыСубконто.Клиенты) = 1 Цикл
				               
			Если Ит.КорСубконто(ВидыСубконто.Клиенты)=Константа.ОсновнойПокупатель Тогда
				Продолжить;
			КонецЕсли;     

			Если Ит.КорДО()-Ит.КорКО()>1000 Тогда //выводить если больше 1000
				Ит.ВыбратьВалюты(1);
				Пока Ит.ПолучитьВалюту() = 1 Цикл 
					Если Ит.КорДО(2)-Ит.КорКО(2)>0 Тогда
						Клиенты_.НоваяСтрока();
						Клиенты_.ВидСделки="pўrdoєana";
						Клиенты_.Клиент=Ит.КорСубконто(ВидыСубконто.Клиенты);
						Клиенты_.Получено=Ит.КорДО()-Ит.КорКО();
						Клиенты_.Выдано=0;
						Клиенты_.Валюта=Ит.Валюта;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
	
		КонецЦикла;
	КонецЦикла;
                 

	Запрос = СоздатьОбъект("Запрос");
	ТекстЗапроса = 
	"//{{ЗАПРОС(ВыдачаНаличных)
	|Период с ВыбНачПериода по ВыбКонПериода;
	|Клиент = Документ.АвансовыйОтчет.Клиент;
	|Валюта = Документ.АвансовыйОтчет.Валюта;
	|СуммаРасход = Документ.АвансовыйОтчет.СуммаРасход;
	|СуммаПриход = Документ.АвансовыйОтчет.СуммаПолуч;
	|ТекДок = Документ.АвансовыйОтчет.ТекущийДокумент;
	|Функция СуммаРасходСумма = Сумма(СуммаРасход);
	|Функция СуммаПриходСумма = Сумма(СуммаПриход);
	|Группировка Клиент без групп;
	|Группировка Валюта;
	|Условие (Клиент<>Константа.ОсновнойПокупатель);
	|"//}}ЗАПРОС
	;
	// Если ошибка в запросе, то выход из процедуры
	Если Запрос.Выполнить(ТекстЗапроса) = 0 Тогда
		Возврат;
	КонецЕсли;
		
	// Заполнение полей "Заголовок"

	Пока Запрос.Группировка(1) = 1 Цикл
		// Заполнение полей Клиент

		Если Запрос.СуммаРасходСумма>1000 Тогда
		
			Пока Запрос.Группировка(2) = 1 Цикл
				// Заполнение полей Валюта                 
				Клиенты_.НоваяСтрока();
				Клиенты_.ВидСделки="pirkєana";
				Клиенты_.Клиент=Запрос.Клиент;
				Клиенты_.Получено=0;
				Клиенты_.Выдано=Запрос.СуммаРасходСумма;
				Клиенты_.Валюта=Запрос.Валюта;
			КонецЦикла;
		ИначеЕсли Запрос.СуммаПриходСумма>1000 Тогда
			Пока Запрос.Группировка(2) = 1 Цикл
    			Клиенты_.НоваяСтрока();
				Клиенты_.ВидСделки="pўrdoєana";
				Клиенты_.Клиент=Запрос.Клиент;
				Клиенты_.Получено=Запрос.СуммаПриходСумма;
				Клиенты_.Выдано=0;
				Клиенты_.Валюта=Запрос.Валюта;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;


	Клиенты_.Сортировать("Клиент,ВидСделки,Валюта");
	
	Клиенты_.ВыбратьСтроки();
	    
	Таб.ВывестиСекцию("Шапка");
	            
	НП=0;
	Пока Клиенты_.ПолучитьСтроку()=1 Цикл

		НП=НП+1;
		Таб.ВывестиСекцию("Подробно");

	КонецЦикла;
	
	Таб.ВывестиСекцию("Подвал");
	
	Таб.Опции(0,0,0,0);
	Таб.ПараметрыСтраницы(1,100,1,10,10,10,5,10,10,1);
	Таб.Защита(Константа.ФлагЗащитыТаблиц);
	Таб.ТолькоПросмотр(1);
	Таб.Показать("ЗаНаличные","");
КонецПроцедуры
//}}БУХГАЛТЕРСКИЙ ЗАПРОС


  

Процедура ПриОткрытии()

//{{ИНИЦИАЛИЗАЦИЯ БУХГАЛТЕРСКОГО ЗАПРОСА(ЗаНаличные)
	ВыбНачПериода = НачалоПериодаБИ();
	ВыбКонПериода = КонецПериодаБИ();
//{{ИНИЦИАЛИЗАЦИЯ БУХГАЛТЕРСКОГО ЗАПРОСА

КонецПроцедуры    

//*******************************************
// Процедура генерации запроса СделкиВНаличных.
//
Процедура СделкиВНаличных()
	Перем Запрос, ТекстЗапроса;
	начЛог = семЗаписатьЛогНач( "Отчет", "Сделки в наличных деньгах", "Обработка", "Формирование отчета" );
	//Создание объекта типа Запрос
	Запрос = СоздатьОбъект("Запрос");
	ТекстЗапроса = 
	"//{{ЗАПРОС(СделкиВНаличных)
	|Период С ВыбНачПериода По ВыбКонПериода;
	|Клиент = Документ.РасходнаяНакладнаяНал.Клиент,Документ.ПриходныйОрдерТБ.Клиент,Документ.РасходныйОрдерТБ.Клиент;
	|Страна = Документ.РасходнаяНакладнаяНал.Клиент.Страна,Документ.ПриходныйОрдерТБ.Клиент.Страна,Документ.РасходныйОрдерТБ.Клиент.Страна;
	|Валюта = Документ.РасходнаяНакладнаяНал.Валюта,Документ.ПриходныйОрдерТБ.Валюта,Документ.РасходныйОрдерТБ.Валюта;
	|ВидКонтрагента = Документ.РасходнаяНакладнаяНал.Клиент.ВидКонтрагента, Документ.ПриходныйОрдерТБ.Клиент.ВидКонтрагента, Документ.РасходныйОрдерТБ.Клиент.ВидКонтрагента;
	|Курс = Документ.РасходнаяНакладнаяНал.Курс,Документ.ПриходныйОрдерТБ.Курс,Документ.РасходныйОрдерТБ.Курс;
	|ВидОплаты = Документ.РасходныйОрдерТБ.ВидОплаты;
	|Сумма = Документ.РасходнаяНакладнаяНал.Сумма;
	|СуммаКас = Документ.ПриходныйОрдерТБ.Сумма;
	|СуммаВоз = Документ.РасходныйОрдерТБ.Сумма;
	|НДС = Документ.РасходнаяНакладнаяНал.НДС;
	|Функция СуммаБазОбщ = Сумма(Сумма*Курс+НДС*Курс+СуммаКас) когда(СуммаКас>=0);
	|Функция СуммаВалОбщ = Сумма(Сумма+НДС+СуммаКас) когда(СуммаКас>=0);
	|Функция СуммаВозОбщ = Сумма(СуммаВоз) когда(ВидОплаты = Перечисление.ВидыОплаты.Возврат);
	|Группировка Клиент упорядочить по Клиент.ПоАлфавиту без групп;
	|Группировка Валюта;
	|Условие(Клиент<>Константа.ОсновнойПокупатель);
	|Условие(ВидКонтрагента<>Перечисление.ВидыКонтрагентов.ЧастноеЛицо);
	|"//}}ЗАПРОС
	;
	// Если ошибка в запросе, то выход из процедуры
	Если Запрос.Выполнить(ТекстЗапроса) = 0 Тогда
		Возврат;
	КонецЕсли;

	Таб = СоздатьОбъект("Таблица");
	Таб.ИсходнаяТаблица("ЗаНаличные");
                             
	КодНДС=Константа.ОсновнаяФирма.ИНН;
	Таб.ВывестиСекцию("Заголовок");
	
	Клиенты_.УдалитьСтроки();
	
	// Подготовка к заполнению выходных форм данными запроса

	// Заполнение полей "Заголовок"

	Пока Запрос.Группировка(1) = 1 Цикл
		// Заполнение полей Клиент
		Если Запрос.СуммаБазОбщ>1000 Тогда
                                                  
			Пока Запрос.Группировка(2) = 1 Цикл
				// Заполнение полей Валюта                 
				Клиенты_.НоваяСтрока();
				Клиенты_.ВидСделки="pўrdoєana";
				Клиенты_.Клиент=Запрос.Клиент;
				Клиенты_.Страна=?(ПустоеЗначение(Запрос.Страна)=1,Константа.СтранаРезидент,Запрос.Страна);
				Клиенты_.Получено=Запрос.СуммаВалОбщ-Запрос.СуммаВозОбщ;
				Клиенты_.Выдано=0;
				Клиенты_.Валюта=Запрос.Валюта;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;

	// Вывод заполненной формы
	
	Клиенты_.Сортировать("Клиент,ВидСделки,Валюта");
	
	Клиенты_.ВыбратьСтроки();
	    
	Таб.ВывестиСекцию("Шапка");
	            
	НП=0;
	Пока Клиенты_.ПолучитьСтроку()=1 Цикл

		НП=НП+1;
		Таб.ВывестиСекцию("Подробно");

	КонецЦикла;
	
	Таб.ВывестиСекцию("Подвал");
	
	Таб.Опции(0,0,0,0);
	Таб.ПараметрыСтраницы(1,100,1,10,10,10,5,10,10,1);
	Таб.Защита(Константа.ФлагЗащитыТаблиц);
	Таб.ТолькоПросмотр(1);
	Таб.Показать("ЗаНаличные","");
	
	семЗаписатьЛогКон( начЛог );	
КонецПроцедуры

Клиенты_=СоздатьОбъект("ТаблицаЗначений");

Клиенты_.НоваяКолонка("Клиент","Справочник.Клиенты");
Клиенты_.НоваяКолонка("ВидСделки","Строка",20);
Клиенты_.НоваяКолонка("Получено","Число",18,2);
Клиенты_.НоваяКолонка("Выдано","Число",18,2);
Клиенты_.НоваяКолонка("Валюта","Справочник.Валюты");
Клиенты_.НоваяКолонка("Страна","Справочник.Страны");

ВыбНачПериода=НачМесяца(РабочаяДата());
ВыбКонПериода=КонМесяца(ВыбНачПериода);