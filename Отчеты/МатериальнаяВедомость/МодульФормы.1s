//*******************************************
Перем СЦеной;
//-------------------------------  
Процедура Очистить()
	ВыбТовар=0;
	ВыбСклад=0; 
//	ВыбЦена=0;
КонецПроцедуры     
//-------------------------------     
Функция ДатьРодителя(Элем)
	Спр=СоздатьОбъект("Справочник.Номенклатура");
	Спр.НайтиЭлемент(Элем);
	Если Спр.Уровень()>1  Тогда
		Спр.НайтиЭлемент(Спр.Родитель);
		Возврат Спр.Наименование;
	Иначе
		Возврат 0;
	КонецЕсли;            
КонецФункции
//----------------------
Процедура ТоварыЗаПериоды(Режим)
	Рег1=СоздатьОбъект("Регистр.ПартииТоваров");
	Запрос=СоздатьОбъект("Запрос");
	ТекстЗапроса="Period from {ДатаОтчета}";
	Если ДатаКонца>=ПолучитьДатуТА() Тогда
		ДатаКонца=ПолучитьДатуТА();
		ТекстЗапроса=ТекстЗапроса+";" ;
	Иначе
		ТекстЗапроса=ТекстЗапроса+" till {ДатаКонца};";
	КонецЕсли;
	ТекстЗапроса=ТекстЗапроса+"	
	|Склад=Регистр.ПартииТоваров.Склад;
	|Товар=Регистр.ПартииТоваров.Товар;
	|Кол=Регистр.ПартииТоваров.ОстатокТовара;
	|БазСтоим=Регистр.ПартииТоваров.Стоимость;";  
	Если ВыбТовар.Выбран()=0 Тогда
		//Без условий
		Заг="Pa visўm prec§m.";
	ИначеЕсли ВыбТовар.ЭтоГруппа()=1 Тогда
		ТекстЗапроса=ТекстЗапроса+"Условие (Товар в ВыбТовар);";
		Заг="Pa grupam "+ВыбТовар.Код+" "+ВыбТовар.Наименование;
	Иначе
		ТекстЗапроса=ТекстЗапроса+"Условие (Товар={ВыбТовар});";
		Заг="Prece "+ВыбТовар.Код+" "+ВыбТовар.Наименование;
	КонецЕсли;
	Если ВыбСклад.Выбран()=0 Тогда
		//Без условий
		Заг1="Pa visўm noliktavўm"; 
	ИначеЕсли ВыбСклад.ЭтоГруппа()=1 Тогда
		ТекстЗап=ТекстЗап+"Условие (Склад в ВыбСклад);";
		Заг1="Pa grupam "+ВыбСклад.Наименование+".";
	Иначе
		ТекстЗап=ТекстЗап+"Условие (Склад={ВыбСклад});";
		Заг1="Noliktava "+ВыбСклад.Наименование+".";
	КонецЕсли;
	Если ВыбЦена.выбран()=0 Тогда
		Заг2="Iepirkuma cenas"; 
	Иначе
		Заг2="Realizўcijas cenas"; 
	КонецЕсли;
	ТекстЗапроса=ТекстЗапроса+"
	|Группировка Товар;
	|Группировка Склад;";
	Если Режим = "ПоМесяцам" Тогда
		ТекстЗапроса=ТекстЗапроса+"
		|Группировка Месяц;";
	КонецЕсли; 
	Если Режим = "ПоДням" Тогда
		ТекстЗапроса=ТекстЗапроса+"
		|Группировка День;";
	КонецЕсли;  
	Если Режим = "Подробно" Тогда
		ТекстЗапроса=ТекстЗапроса+"
		|Группировка День;";
	КонецЕсли;
	ТекстЗапроса=ТекстЗапроса+"
	|Функция НачКол= НачОст(Кол);
	|Функция КонКол= КонОст(Кол);
	|Функция ПрихКол= Приход(Кол);
	|Функция РасхКол= Расход(Кол);
	|Функция БазРасх= Расход(БазСтоим);
	|Функция БазПрих= Приход(БазСтоим);
	|Функция БазСтНач=НачОст(БазСтоим);
	|Функция БазСтоимость=КонОст(БазСтоим);";
	Флаг=Запрос.Выполнить(ТекстЗапроса);
	Если Флаг=0 тогда
		Возврат;
	КонецЕсли;
	
	КонечныйОстаток=0;
	КонечнаяСтоимость=0;	
	СтрокЧисло=0;
	//  Создание Таблицы для выходного отчета
	Таб=СоздатьОбъект("Таблица");
	Если СЦеной=0 Тогда
		Таб.ИсходнаяТаблица("Таблица1");
	Иначе
		Таб.ИсходнаяТаблица("ТоварыПоПериодам");
	КонецЕсли;
	Таб.ВывестиСекцию("Отчет");
	СтрокЧисло=СтрокЧисло+4;
	Состояние("В отчет выведено "+СтрокЧисло+" строк.");
	Пока Запрос.Группировка("Товар") = 1 Цикл
		Если Запрос.Товар.ЭтоГруппа()=1 Тогда 
			Если ВыбЦена.выбран()=0 Тогда
				Таб.ВывестиСекцию("Группа");
			Иначе
				Таб.ВывестиСекцию("ГруппаРеал");
			КонецЕсли; 
			СтрокЧисло=СтрокЧисло+1;
			Состояние("В отчет выведено "+СтрокЧисло+" строк.");
			Продолжить;
		Иначе
			Если КонечныйОстаток<>0 Тогда 
				КонечныйОстаток=0;
			КонецЕсли; 
			Если ВыбЦена.выбран()=0 Тогда
				Таб.ВывестиСекцию("Товар");
			Иначе
				Таб.ВывестиСекцию("ТоварРеал");
			КонецЕсли; 
			СтрокЧисло=СтрокЧисло+1;
			Состояние("В отчет выведено "+СтрокЧисло+" строк.");
		КонецЕсли;
		Пока Запрос.Группировка("Склад") = 1 Цикл 
			// Проверим условие выбора склада
			Если Запрос.Склад.ЭтоГруппа()=1 Тогда
				Если (ВыбСклад.Выбран()=0) ИЛИ
				(Запрос.Склад.ПринадлежитГруппе(ВыбСклад)=1) Тогда 
					Если ВыбЦена.выбран()=0 Тогда   
						Таб.ВывестиСекцию("Склад");
					Иначе
						Таб.ВывестиСекцию("СкладРеал");
					КонецЕсли; 
					СтрокЧисло=СтрокЧисло+1;
					Состояние("В отчет выведено "+СтрокЧисло+" строк.");
				Иначе
					Продолжить;
				КонецЕсли;
			ИначеЕсли Запрос.Склад.ЭтоГруппа()=0 Тогда
				Если ((ВыбСклад.ЭтоГруппа()=1) И
				(Запрос.Склад.ПринадлежитГруппе(ВыбСклад)=1)) ИЛИ
				((ВыбСклад.ЭтоГруппа()=0) И
				(ВыбСклад.Выбран()=1) И
				(ВыбСклад.ПолныйКод()=Запрос.Склад.ПолныйКод())) ИЛИ
				(ВыбСклад.Выбран()=0)  Тогда 
					Если ВыбЦена.Выбран()=0 Тогда   
						Если ВыбСклад.Выбран()=0 Тогда
							Таб.ВывестиСекцию("Склад");  
							СтрокЧисло=СтрокЧисло+1;
							Состояние("В отчет выведено "+СтрокЧисло+" строк.");
						КонецЕсли;
					Иначе
						Если ВыбСклад.Выбран()=0 Тогда
							Таб.ВывестиСекцию("СкладРеал"); 
							СтрокЧисло=СтрокЧисло+1;
							Состояние("В отчет выведено "+СтрокЧисло+" строк.");
						КонецЕсли;
					КонецЕсли;
				Иначе
					Продолжить;
				КонецЕсли;	
			КонецЕсли;
			Если Режим="ПоДням" Тогда
				Пока Запрос.Группировка("День") = 1 цикл
					Период=Запрос.День;
					Таб.ВывестиСекцию("День");
					СтрокЧисло=СтрокЧисло+1;
					Состояние("В отчет выведено "+СтрокЧисло+" строк.");
				КонецЦикла;
			КонецЕсли;               
			Если Режим="ПоМесяцам" Тогда
				Пока Запрос.Группировка("Месяц") = 1 цикл
					Период=Запрос.Месяц;
					Таб.ВывестиСекцию("Период");
					СтрокЧисло=СтрокЧисло+1;
					Состояние("В отчет выведено "+СтрокЧисло+" строк.");
				КонецЦикла;
			КонецЕсли; 
			///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////         
			Если Режим="Подробно" Тогда
				Пока Запрос.Группировка("День") = 1 цикл
					Период=Запрос.День;
					ФлОбрОст=0;
					Рег1.УстановитьФильтр(Запрос.Товар,Запрос.Склад,);
					Если Период+1>=ПолучитьДатуТА() Тогда
						Рег1.ВыбратьДвижения(Период,0);
					Иначе
						Рег1.ВыбратьДвижения(Период,Период);
					КонецЕсли;
					Пока Рег1.ПолучитьДвижение()>0 Цикл
						Док=Рег1.ТекущийДокумент(); 
						ВидДок=Док.Вид(); 
						ДокКлиент=" ";   
						Если ВидДок<>"Счет" Тогда
							ДокКлиент=" ";
							Если     НЕ((ВидДок="ВводОстатковТоваров") 
							ИЛИ (ВидДок="НарядНаРазукомплектацию")
							ИЛИ (ВидДок="НарядНаСборку")
							ИЛИ (ВидДок="Перемещение") 
							ИЛИ (ВидДок="ПереоценкаТоваров")  
							ИЛИ (ВидДок="Резервирование")  
							ИЛИ (ВидДок="Переработка")  
							ИЛИ	(ВидДок="Списание")) Тогда
								ДокКлиент=Док.Клиент.Код+"  "+Док.Клиент.Наименование;
							КонецЕсли;
							Пр=Рег1.Приход;
							Рс=Рег1.Расход;
							Приращение=Рег1.ОстатокТовара;   
							СтоимостьТовара=Рег1.БазоваяСтоимость;
							Если Пр=1 Тогда
								Если ФлОбрОст=0 Тогда
									Если ВыбЦена.выбран()=0 Тогда 
										Таб.ВывестиСекцию("Приход");
									Иначе
										Таб.ВывестиСекцию("НачДняПрРеал");
									КонецЕсли; 
								Иначе     
									Если ВыбЦена.выбран()=0 Тогда
										Таб.ВывестиСекцию("Приход");
									Иначе
										Таб.ВывестиСекцию("ПриходРеал");
									КонецЕсли; 
								КонецЕсли;
							Иначе 
								Если ФлОбрОст=0 Тогда
									Если ВыбЦена.выбран()=0 Тогда
										Таб.ВывестиСекцию("Расход");
									Иначе
										Таб.ВывестиСекцию("НачДняРРеал");
									КонецЕсли; 
								Иначе     
									Если ВыбЦена.выбран()=0 Тогда
										Таб.ВывестиСекцию("Расход");
									Иначе
										Таб.ВывестиСекцию("РасходРеал");
									КонецЕсли; 
								КонецЕсли;
							КонецЕсли;  
							ФлОбрОст=1; 
						КонецЕсли;
					ENDDO;
					КонечныйОстаток=Запрос.КонКол;
					КонечнаяСтоимость=Запрос.БазСтоимость;
					СтрокЧисло=СтрокЧисло+1;
					Состояние("В отчет выведено "+СтрокЧисло+" строк.");
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	//Вызов выходного отчета в окно просмотра и редактирования.
	Таб.ТолькоПросмотр(1);
	Таб.Опции(0,0,7,0);
	Таб.Показать("Отчет о движении товаров","");
КонецПроцедуры
//-------------------------------  
Процедура ПоСкладам(Режим)                                                            
	начЛог = семЗаписатьЛогНач( "Отчет", "Материальная ведомость", "Обработка", Шаблон("Формирование отчета ([Режим])") );
	Рег1=СоздатьОбъект("Регистр.ПартииТоваров");
	Запрос=СоздатьОбъект("Запрос");
	
	ТекстЗапроса="Period from {ДатаОтчета}";
	Если ДатаКонца>=ПолучитьДатуТА() Тогда
		ДатаКонца=ПолучитьДатуТА();
		ТекстЗапроса=ТекстЗапроса+";" ;
	Иначе
		ТекстЗапроса=ТекстЗапроса+" till {ДатаКонца};";
	КонецЕсли;                  
	
	ТекстЗапроса=ТекстЗапроса+"	
	|Склад=Регистр.ПартииТоваров.Склад"+?(ФлСпецРез=1,",Регистр.РезервыТоваров.ПоСчету.Склад","")+";
	|Товар=Регистр.ПартииТоваров.Товар"+?(ФлСпецРез=1,",Регистр.РезервыТоваров.Товар","")+";
	|Кол=Регистр.ПартииТоваров.ОстатокТовара;
	|БазСтоим=Регистр.ПартииТоваров.Стоимость;";
	
	Если ФлСпецРез=1 Тогда
		ТекстЗапроса=ТекстЗапроса+"	
		|Рез=Регистр.РезервыТоваров.РезервТовара;";
	КонецЕсли;
	
	
	Если ВыбЦена.Выбран()=0 Тогда
		Заг2="Iepirkuma cenas"; 
	Иначе
		Заг2="Realizўcijas cenas"; 
	КонецЕсли;
	
	ТекстЗапроса=ТекстЗапроса+"
	|Группировка Склад;
	|Группировка Товар;";
	
	Если Режим = "Подробно" Тогда
		ТекстЗапроса=ТекстЗапроса+"
		|Группировка День;";
	КонецЕсли; 
	
	ТекстЗапроса=ТекстЗапроса+"
	|Функция НачКол= НачОст(Кол);
	|Функция КонКол= КонОст(Кол);
	|Функция ПрихКол= Приход(Кол);
	|Функция РасхКол= Расход(Кол);
	|Функция БазРасх= Расход(БазСтоим);
	|Функция БазПрих= Приход(БазСтоим);
	|Функция БазСтНач=НачОст(БазСтоим);
	|Функция БазСтоимость=КонОст(БазСтоим);";    
	
	Если ФлСпецРез=1 Тогда
		ТекстЗапроса=ТекстЗапроса+"
		|Функция НачКолРез= НачОст(Рез);
		|Функция КонКолРез= КонОст(Рез);
		|Функция ПрихКолРез= Приход(Рез);
		|Функция РасхКолРез= Расход(Рез);";
	КонецЕсли;

	Если ВыбТовар.Выбран()=0 Тогда
		//Без условий
		Заг="Pa visўm prec§m.";
	ИначеЕсли ВыбТовар.ЭтоГруппа()=1 Тогда
		ТекстЗапроса=ТекстЗапроса+"Условие (Товар в ВыбТовар);";
		Заг="Pa grupam "+ВыбТовар.Код+" "+ВыбТовар.Наименование;
	Иначе
		ТекстЗапроса=ТекстЗапроса+"Условие (Товар={ВыбТовар});";
		Заг="Prece "+ВыбТовар.Код+" "+ВыбТовар.Наименование;
	КонецЕсли;
	
	Если ВыбСклад.Выбран()=0 Тогда
		//Без условий
		Заг1="Pa visўm noliktavўm"; 
	ИначеЕсли ВыбСклад.ЭтоГруппа()=1 Тогда
		ТекстЗапроса=ТекстЗапроса+"Условие (Склад в ВыбСклад);";
		Заг1="Pa grupam "+ВыбСклад.Наименование+".";
	Иначе
		ТекстЗапроса=ТекстЗапроса+"Условие (Склад={ВыбСклад});";
		Заг1="Noliktava "+ВыбСклад.Наименование+".";
	КонецЕсли;

	Флаг=Запрос.Выполнить(ТекстЗапроса);
	
	Если Флаг=0 тогда
		Возврат;
	КонецЕсли;
	
	КонечныйОстаток=0;
	КонечнаяСтоимость=0;
	НОстПоГр=0;
	ПрПоГр=0;
	РсПоГр=0;
	КОстПоГр=0;
	НОстПоВерхГр=0;
	ПрПоВерхГр=0;
	РсПоВерхГр=0;
	КОстПоВерхГр=0;
	ИтогоНОстПоСкл=0;
	ИтогоПрПоСкл=0;
	ИтогоРсПоСкл=0;
	ИтогоКОстПоСкл=0;   
	
	НОстПоГрРез=0; 
	ПрПоГрРез=0;
	РсПоГрРез=0;
	КОстПоГрРез=0;
	НОстПоВерхГрРез=0;
	ПрПоВерхГрРез=0;
	РсПоВерхГрРез=0;
	КОстПоВерхГрРез=0;
	ИтогоНОстПоСклРез=0;
	ИтогоПрПоСклРез=0;
	ИтогоРсПоСклРез=0;
	ИтогоКОстПоСклРез=0;   
	
	НСтоПоГр=0;
	ПрСтоПоГр=0;
	РсСтоПоГр=0;
	КСтоПоГр=0;
	НСтоПоВерхГр=0;
	ПрСтоПоВерхГр=0;
	РсСтоПоВерхГр=0;
	КСтоПоВерхГр=0;
	ИтогоНСтоПоСкл=0;
	ИтогоПрСтоПоСкл=0;
	ИтогоРсСтоПоСкл=0;
	ИтогоКСтоПоСкл=0;
	НСто=0;
	ПрСто=0;
	РсСто=0;
	КСто=0;
	СтрокЧисло=0;
	//  Создание Таблицы для выходного отчета
	Таб=СоздатьОбъект("Таблица"); 
	Если ВыбЦена.Выбран()=1 Тогда
		Таб.ИсходнаяТаблица("Новая");
	Иначе  
		Если ФлСпецРез=1 Тогда
			Таб.ИсходнаяТаблица("ПоСпецРезерву");   
		Иначе
			Таб.ИсходнаяТаблица("ТоварыПоПериодам1");
		КонецЕсли;
	КонецЕсли;                
	Таб.ВывестиСекцию("Отчет");
	СтрокЧисло=СтрокЧисло+4;
	Состояние("В отчет выведено "+СтрокЧисло+" строк."); 
	ФлГруппы=0;
	ФлВерхГруппы=0;
	ФлВывВерхГруппы=0;
	УрВерхГруппы=0;
	Пока Запрос.Группировка("Склад") = 1 Цикл 
		// Проверим условие выбора склада
		Если Запрос.Склад.ЭтоГруппа()=1 Тогда
			Таб.ВывестиСекцию("ГруппаСклад");
			СтрокЧисло=СтрокЧисло+1;
			Состояние("В отчет выведено "+СтрокЧисло+" строк.");
			Продолжить;
		КонецЕсли;   
		ФлГруппы=0;
		ФлВерхГруппы=0;
		ФлВывВерхГруппы=0;
		Пока Запрос.Группировка("Товар") = 1 Цикл
			Если Запрос.Товар.ЭтоГруппа()=1 Тогда 
				// Выведем итоги по группе товаров 				
				Если ФлГруппы=1 Тогда
					Если ВыбЦена.Выбран()=1 Тогда
						Таб.ВывестиСекцию("ИтогоПоГр");
					КонецЕсли; 
					СтрокЧисло=СтрокЧисло+1;
					Состояние("В отчет выведено "+СтрокЧисло+" строк."); 
					ФлГруппы=0;
					// Собираем итоги по верхней группе
					Если ФлВерхГруппы=1 Тогда 
						НОстПоВерхГр=НОстПоВерхГр+НОстПоГр;
						ПрПоВерхГр=ПрПоВерхГр+ПрПоГр;
						РсПоВерхГр=РсПоВерхГр+РсПоГр;
						КОстПоВерхГр=КОстПоВерхГр+КОстПоГр;  
						НСтоПоВерхГр=НСтоПоВерхГр+НСтоПоГр;
						ПрСтоПоВерхГр=ПрСтоПоВерхГр+ПрСтоПоГр;
						РсСтоПоВерхГр=РсСтоПоВерхГр+РсСтоПоГр;
						КСтоПоВерхГр=КСтоПоВерхГр+КСтоПоГр;  
						Если ФлСпецРез=1 Тогда
							НОстПоВерхГрРез=НОстПоВерхГрРез+НОстПоГрРез;
							ПрПоВерхГрРез=ПрПоВерхГрРез+ПрПоГрРез;
							РсПоВерхГрРез=РсПоВерхГрРез+РсПоГрРез;
							КОстПоВерхГрРез=КОстПоВерхГрРез+КОстПоГрРез;   
						КонецЕсли;
						// Выводим итоги по верхней группе
						Если (Запрос.Товар.Уровень()<=УрВерхГруппы)   Тогда
							Если ВыбЦена.Выбран()=1 Тогда
								Таб.ВывестиСекцию("ИтогоПоВерхГр");
							КонецЕсли; 
							СтрокЧисло=СтрокЧисло+1;
							Состояние("В отчет выведено "+СтрокЧисло+" строк."); 
							ФлВерхГруппы=0;
						КонецЕсли;
					КонецЕсли;	
				КонецЕсли; 
				// Название новой группы товаров
				НазвГр=Запрос.Товар.Наименование;
				// Название верхней группы
				НазвВерхГр=ДатьРодителя(Запрос.Товар);
				
				Если ВыбЦена.Выбран()=0 Тогда
					Таб.ВывестиСекцию("Группа");
				Иначе
					Таб.ВывестиСекцию("ГруппаРеал");
				КонецЕсли; 
				
				СтрокЧисло=СтрокЧисло+1;
				Состояние("В отчет выведено "+СтрокЧисло+" строк.");
				Продолжить;
			Иначе  
				Если ФлГруппы=0 Тогда 
					// Обнуляем переменные для новой товарной группы
					ФлГруппы=1;
					НОстПоГр=0;
					ПрПоГр=0;
					РсПоГр=0; 
					КОстПоГр=0; 
					НОстПоГрРез=0;     
					ПрПоГрРез=0;
					РсПоГрРез=0; 
					КОстПоГрРез=0;     
					НСтоПоГр=0;
					ПрСтоПоГр=0;
					РсСтоПоГр=0;
					КСтоПоГр=0; 
					// Определяем уровень верхней отчетной группы 
					Если ФлВерхГруппы=0 Тогда
						УрВерхГруппы=Запрос.Товар.Уровень()-2;
						Если УрВерхГруппы>0 Тогда
							ФлВерхГруппы=1; 
							НОстПоВерхГр=0;
							ПрПоВерхГр=0;
							РсПоВерхГр=0; 
							КОстПоВерхГр=0; 
							НОстПоВерхГрРез=0;
							ПрПоВерхГрРез=0;
							РсПоВерхГрРез=0; 
							КОстПоВерхГрРез=0; 
							НСтоПоВерхГр=0;
							ПрСтоПоВерхГр=0;
							РсСтоПоВерхГр=0;
							КСтоПоВерхГр=0; 
						КонецЕсли; 
					КонецЕсли;
				КонецЕсли;
				
				Если КонечныйОстаток<>0 Тогда 
					КонечныйОстаток=0;
				КонецЕсли;   
				Если ФлСпецРез=1 Тогда
					Если  (Запрос.НачКол<>0) Или (Запрос.ПрихКол<>0) Или (Запрос.РасхКол<>0) Или
					(Запрос.КонКол<>0) Или (Запрос.НачКолРез<>0) Или (Запрос.ПрихКолРез<>0) Или 
					(Запрос.РасхКолРез<>0) Или (Запрос.КонКолРез<>0) Тогда
						Если ВыбЦена.Выбран()=0 Тогда
							Таб.ВывестиСекцию("Товар");
						Иначе
							НСто=ЦенаТовараПоКатегорииДляТовара(Запрос.Товар,выбЦена,,,ДатаКонца)*Запрос.НачКол;
							ПрСто=ЦенаТовараПоКатегорииДляТовара(Запрос.Товар,выбЦена,,,ДатаКонца)*Запрос.ПрихКол;
							РсСто=ЦенаТовараПоКатегорииДляТовара(Запрос.Товар,выбЦена,,,ДатаКонца)*Запрос.РасхКол;
							КСто=ЦенаТовараПоКатегорииДляТовара(Запрос.Товар,выбЦена,,,ДатаКонца)*Запрос.КонКол;
							Таб.ВывестиСекцию("ТоварРеал");    
						КонецЕсли;  
						НОстПоГр=НОстПоГр+Запрос.НачКол;
						ПрПоГр=ПрПоГр+Запрос.ПрихКол;
						РсПоГр=РсПоГр+Запрос.РасхКол;
						КОстПоГр=КОстПоГр+Запрос.КонКол;
						Если ФлСпецРез=1 Тогда
							НОстПоГрРез=НОстПоГрРез+Запрос.НачКолРез;
							ПрПоГрРез=ПрПоГрРез+Запрос.ПрихКолРез;
							РсПоГрРез=РсПоГрРез+Запрос.РасхКолРез;
							КОстПоГрРез=КОстПоГрРез+Запрос.КонКолРез;     
						КонецЕсли;
						НСтоПоГр=НСтоПоГр+НСто;
						ПрСтоПоГр=ПрСтоПоГр+ПрСто;
						РсСтоПоГр=РсСтоПоГр+РсСто;
						КСтоПоГр=КСтоПоГр+КСто;
						
						ИтогоНОстПоСкл=ИтогоНОстПоСкл+Запрос.НачКол;
						ИтогоПрПоСкл=ИтогоПрПоСкл+Запрос.ПрихКол;
						ИтогоРсПоСкл=ИтогоРсПоСкл+Запрос.РасхКол;
						ИтогоКОстПоСкл=ИтогоКОстПоСкл+Запрос.КонКол;  
						Если ФлСпецРез=1 Тогда
							ИтогоНОстПоСклРез=ИтогоНОстПоСклРез+Запрос.НачКолРез;
							ИтогоПрПоСклРез=ИтогоПрПоСклРез+Запрос.ПрихКолРез;
							ИтогоРсПоСклРез=ИтогоРсПоСклРез+Запрос.РасхКолРез;
							ИтогоКОстПоСклРез=ИтогоКОстПоСклРез+Запрос.КонКолРез;  
						КонецЕсли;
						ИтогоНСтоПоСкл=ИтогоНСтоПоСкл+НСто;
						ИтогоПрСтоПоСкл=ИтогоПрСтоПоСкл+ПрСто;
						ИтогоРсСтоПоСкл=ИтогоРсСтоПоСкл+РсСто;
						ИтогоКСтоПоСкл=ИтогоКСтоПоСкл+КСто;
						СтрокЧисло=СтрокЧисло+1;
						Состояние("В отчет выведено "+СтрокЧисло+" строк.");
					Иначе
						Продолжить;
					КонецЕсли;
				Иначе		
					Если  (Запрос.НачКол<>0) Или (Запрос.ПрихКол<>0) Или (Запрос.РасхКол<>0) Или
					(Запрос.КонКол<>0) Тогда
						Если ВыбЦена.Выбран()=0 Тогда
							Таб.ВывестиСекцию("Товар");
						Иначе
							НСто=ЦенаТовараПоКатегорииДляТовара(Запрос.Товар,выбЦена,,,ДатаКонца)*Запрос.НачКол;
							ПрСто=ЦенаТовараПоКатегорииДляТовара(Запрос.Товар,выбЦена,,,ДатаКонца)*Запрос.ПрихКол;
							РсСто=ЦенаТовараПоКатегорииДляТовара(Запрос.Товар,выбЦена,,,ДатаКонца)*Запрос.РасхКол;
							КСто=ЦенаТовараПоКатегорииДляТовара(Запрос.Товар,выбЦена,,,ДатаКонца)*Запрос.КонКол;
							Таб.ВывестиСекцию("ТоварРеал");    
						КонецЕсли;  
						НОстПоГр=НОстПоГр+Запрос.НачКол;
						ПрПоГр=ПрПоГр+Запрос.ПрихКол;
						РсПоГр=РсПоГр+Запрос.РасхКол;
						КОстПоГр=КОстПоГр+Запрос.КонКол;
						Если ФлСпецРез=1 Тогда
							НОстПоГрРез=НОстПоГрРез+Запрос.НачКолРез;
							ПрПоГрРез=ПрПоГрРез+Запрос.ПрихКолРез;
							РсПоГрРез=РсПоГрРез+Запрос.РасхКолРез;
							КОстПоГрРез=КОстПоГрРез+Запрос.КонКолРез;  
						КонецЕсли;
						НСтоПоГр=НСтоПоГр+НСто;
						ПрСтоПоГр=ПрСтоПоГр+ПрСто;
						РсСтоПоГр=РсСтоПоГр+РсСто;
						КСтоПоГр=КСтоПоГр+КСто;
						
						ИтогоНОстПоСкл=ИтогоНОстПоСкл+Запрос.НачКол;
						ИтогоПрПоСкл=ИтогоПрПоСкл+Запрос.ПрихКол;
						ИтогоРсПоСкл=ИтогоРсПоСкл+Запрос.РасхКол;
						ИтогоКОстПоСкл=ИтогоКОстПоСкл+Запрос.КонКол;  
						Если ФлСпецРез=1 Тогда    
							ИтогоНОстПоСклРез=ИтогоНОстПоСклРез+Запрос.НачКолРез;
							ИтогоПрПоСклРез=ИтогоПрПоСклРез+Запрос.ПрихКолРез;
							ИтогоРсПоСклРез=ИтогоРсПоСклРез+Запрос.РасхКолРез;
							ИтогоКОстПоСклРез=ИтогоКОстПоСклРез+Запрос.КонКолРез;       
						КонецЕсли;
						ИтогоНСтоПоСкл=ИтогоНСтоПоСкл+НСто;
						ИтогоПрСтоПоСкл=ИтогоПрСтоПоСкл+ПрСто;
						ИтогоРсСтоПоСкл=ИтогоРсСтоПоСкл+РсСто;
						ИтогоКСтоПоСкл=ИтогоКСтоПоСкл+КСто;
						СтрокЧисло=СтрокЧисло+1;
						Состояние("В отчет выведено "+СтрокЧисло+" строк.");
					Иначе
						Продолжить;
					КонецЕсли;   
				КонецЕсли;
				
			КонецЕсли;
			/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////         
			Если Режим="Подробно" Тогда
				Пока Запрос.Группировка("День") = 1 цикл
					Период=Запрос.День;
					ФлОбрОст=0;
					Пр=0;
					Рс=0;
					Приращение=0;
					ПриращениеСпРез=0;
					ПриращениеРез=0;
					СтоимостьТовара=0;
					
					РегСР=СоздатьОбъект("Регистр.РезервыТоваров");
					
					Рег1.УстановитьЗначениеФильтра("Товар",Запрос.Товар,1);
					Рег1.УстановитьЗначениеФильтра("Склад",Запрос.Склад,1);
					
					Если Период>=ПолучитьДатуТА() Тогда
						Рег1.ВыбратьДвижения(Период,0);
					Иначе
						Рег1.ВыбратьДвижения(Период,Период);
					КонецЕсли;
					
					РегСР.УстановитьФильтр(Запрос.Товар);
					
					Если Период>=ПолучитьДатуТА() Тогда
						РегСР.ВыбратьДвижения(Период,0);
					Иначе
						РегСР.ВыбратьДвижения(Период,Период);
					КонецЕсли;
					
					Пока РегСР.ПолучитьДвижение()=1 Цикл
						Док=РегСР.ТекущийДокумент();  
						
						Если глЕстьРеквизитШапки("Клиент",Док.Вид())=1 Тогда
							ДокКлиент=Док.Клиент.Код+"  "+Док.Клиент.Наименование;
						Иначе
							ДокКлиент="";
						КонецЕсли;
						                
						
						ПриращениеСпРез=РегСР.РезервТовара;
						ПриращениеРез=ПриращениеСпРез;
                            
						Таб.ВывестиСекцию(?(РегСР.Приход=1,"Приход","Расход"));
						
					КонецЦикла;
					
					
					ПриращениеСпРез=0;
					ПриращениеРез=0;
					Пока Рег1.ПолучитьДвижение()>0 Цикл
						Док=Рег1.ТекущийДокумент();  
						ВидДок=Док.Вид();
						ДокКлиент=" ";
						
						Если     НЕ((ВидДок="ВводОстатковТоваров") 
						ИЛИ (ВидДок="НарядНаРазукомплектацию")
						ИЛИ (ВидДок="НарядНаСборку")
						ИЛИ (ВидДок="Перемещение") 
						ИЛИ (ВидДок="ПереоценкаТоваров") 
						ИЛИ (ВидДок="Переработка")  
						ИЛИ (ВидДок="Пересортица")
						ИЛИ (ВидДок="ВедомостьИнвентаризации")  
						ИЛИ (ВидДок="Резервирование")  
						ИЛИ	(ВидДок="Списание")) Тогда
							
							Попытка
								ДокКлиент=Док.Клиент.Код+"  "+Док.Клиент.Наименование;
							Исключение
								ДокКлиент=" ";
//								Сообщить(Док.ТекущийДокумент());
							КонецПопытки;
							
						КонецЕсли;
						
						Пр=Рег1.Приход;
						Рс=Рег1.Расход;
						Приращение=Рег1.ОстатокТовара; 
						
						//РегР.УстановитьФильтр(Запрос.Товар,,);
						//РегР.ВыбратьДвиженияДокумента(Док);
						//
						////Находим по данному документу Резерв;
						//ПриращениеРез=0;
						//Пока РегР.ПолучитьДвижение()=1 Цикл
						//	Если РегР.Товар=Запрос.Товар Тогда
						//		ПриращениеРез=РегР.РезервТовара;
						//		Прервать;
						//	КонецЕсли;						    
						//КонецЦикла;                            
						
						Если (ВидДок="РасходнаяНакладная") ИЛИ
						(ВидДок="РасходнаяНакладнаяНал")	Тогда
							Если ПустоеЗначение(Док.ДокументОснование)=1 Тогда
								ДокОсн=Док;
							Иначе
								ДокОсн=Док.ДокументОснование;
							КонецЕсли;
						Иначе
							ДокОсн=Док;
						КонецЕсли;
						
						СтоимостьТовара=Рег1.Стоимость;
						Если Пр=1 Тогда
							Если ФлОбрОст=0 Тогда
								Если ВыбЦена.Выбран()=0 Тогда   
									Таб.ВывестиСекцию("Приход");
								Иначе
									Таб.ВывестиСекцию("НачДняПрРеал");
								КонецЕсли; 
							Иначе     
								Если ВыбЦена.Выбран()=0 Тогда
									Таб.ВывестиСекцию("Приход");
								Иначе
									Таб.ВывестиСекцию("ПриходРеал");
								КонецЕсли; 
							КонецЕсли;
						Иначе 
							Если ФлОбрОст=0 Тогда
								Если ВыбЦена.Выбран()=0 Тогда 
									Таб.ВывестиСекцию("Расход");
								Иначе
									Таб.ВывестиСекцию("НачДняРРеал");
								КонецЕсли; 
							Иначе     
								Если ВыбЦена.Выбран()=0 Тогда
									Таб.ВывестиСекцию("Расход");
								Иначе
									Таб.ВывестиСекцию("РасходРеал");
								КонецЕсли; 
							КонецЕсли;
						КонецЕсли;  
						ФлОбрОст=1;
					ENDDO; // Получить движение
					
					КонечныйОстаток=Запрос.КонКол; 
					//КонечныйОстатокРез=Запрос.КонКолРез;
					КонечнаяСтоимость=Запрос.БазСтоимость;
					СтрокЧисло=СтрокЧисло+1;
					Состояние("В отчет выведено "+СтрокЧисло+" строк.");
				КонецЦикла; // Группировка день
			КонецЕсли; // Режим Подробно
		КонецЦикла; // Группировка Товар 
		// Выведем итоги по предыдущей группе товаров
		Если ФлГруппы=1 Тогда
			Если ВыбЦена.Выбран()=1 Тогда
				Таб.ВывестиСекцию("ИтогоПоГр");
			КонецЕсли; 
			СтрокЧисло=СтрокЧисло+1;
			Состояние("В отчет выведено "+СтрокЧисло+" строк."); 
			ФлГруппы=0;
		КонецЕсли;
		// Выведем итоги по верхней группе товаров   
		Если ФлВерхГруппы=1 Тогда  
			НОстПоВерхГр=НОстПоВерхГр+НОстПоГр;
			ПрПоВерхГр=ПрПоВерхГр+ПрПоГр;
			РсПоВерхГр=РсПоВерхГр+РсПоГр;
			КОстПоВерхГр=КОстПоВерхГр+КОстПоГр;   
			Если ФлСпецРез=1 Тогда
				НОстПоВерхГрРез=НОстПоВерхГрРез+НОстПоГрРез;
				ПрПоВерхГрРез=ПрПоВерхГрРез+ПрПоГрРез;
				РсПоВерхГрРез=РсПоВерхГрРез+РсПоГрРез;
				КОстПоВерхГрРез=КОстПоВерхГрРез+КОстПоГрРез;   
			КонецЕсли;
			НСтоПоВерхГр=НСтоПоВерхГр+НСтоПоГр;
			ПрСтоПоВерхГр=ПрСтоПоВерхГр+ПрСтоПоГр;
			РсСтоПоВерхГр=РсСтоПоВерхГр+РсСтоПоГр;
			КСтоПоВерхГр=КСтоПоВерхГр+КСтоПоГр;
			Если ВыбЦена.Выбран()=1 Тогда
				Таб.ВывестиСекцию("ИтогоПоВерхГр");
			КонецЕсли; 
			СтрокЧисло=СтрокЧисло+1;
			Состояние("В отчет выведено "+СтрокЧисло+" строк."); 
			ФлВерхГруппы=0;
		КонецЕсли;	
		Если ФлГруппы=1 Тогда
			Если ВыбЦена.Выбран()=1  Тогда
				Таб.ВывестиСекцию("ИтогоПоГр");
			КонецЕсли; 
			СтрокЧисло=СтрокЧисло+1;
			Состояние("В отчет выведено "+СтрокЧисло+" строк."); 
			ФлГруппы=0;
		КонецЕсли; 
		// Выведем итоги по складу
		Если ВыбЦена.Выбран()=0 Тогда
			Таб.ВывестиСекцию("Скл");
		Иначе
			Таб.ВывестиСекцию("ИтогоПоСкладу");
		КонецЕсли;  
		ИтогоНОстПоСкл=0;
		ИтогоПрПоСкл=0;
		ИтогоРсПоСкл=0;
		ИтогоКОстПоСкл=0; 
		ИтогоНОстПоСклРез=0;
		ИтогоПрПоСклРез=0;
		ИтогоРсПоСклРез=0;
		ИтогоКОстПоСклРез=0;   
		ИтогоНСтоПоСкл=0;
		ИтогоПрСтоПоСкл=0;
		ИтогоРсСтоПоСкл=0;
		ИтогоКСтоПоСкл=0
		
	КонецЦикла;  //Группировка Склад
	//Вызов выходного отчета в окно просмотра и редактирования.
	Таб.ТолькоПросмотр(1);
	Таб.Опции(0,0,7,0);
	Таб.Показать("Отчет о движении товаров","");
	семЗаписатьЛогКон( начЛог );	
КонецПроцедуры  
//***********************************************************
//<<Алгоритм Успеха>> (begin)
//_____________________________________________________________________________
Процедура ПриВыбореКатегории()
	Если списТиповЦен.ПолучитьЗначение(списТиповЦен.ТекущаяСтрока())=1 Тогда
	    выбЦена="";
	Иначе
		выбЦена=списТиповЦен.ПолучитьЗначение(списТиповЦен.ТекущаяСтрока());
	КонецЕсли;	
КонецПроцедуры //ПриВыбореКатегории
//_____________________________________________________________________________
Процедура ПриОткрытии() //предопределенная
	Спр=СоздатьОбъект("Справочник.КатегорииЦен");
	Спр.ВыбратьЭлементы();
	Пока Спр.ПолучитьЭлемент()=1 Цикл
	    списТиповЦен.ДобавитьЗначение(Спр.ТекущийЭлемент(),Спр.Наименование);
	КонецЦикла;	                                                       
	списТиповЦен.добавитьЗначение(1,"<Закупочная>");
	Если выбЦена.Выбран()=1 Тогда
	    списТиповЦен.ТекущаяСтрока(списТиповЦен.НайтиЗначение(выбЦена));
	Иначе
		списТиповЦен.ТекущаяСтрока(списТиповЦен.НайтиЗначение(1));
	КонецЕсли;    
	
	глПриОткрытии(Контекст,"МатериальнаяВедомость");
	
КонецПроцедуры //ПриОткрытии       
//<<Алгоритм Успеха>> (end) 
//************************************************************
//-------------------------------  
ДатаОтчета=Константа.ОсновнаяДатаНачалаОтчета;
ДатаКонца=РабочаяДата();
Если Число(ДатаОтчета)=0 Тогда
	ДатаОтчета='01.01.00';
Конецесли;
