//-------------------------------
Процедура УстДата()
	Если ДатаКонца>=ПолучитьДатуТА() Тогда
		Предупреждение("Нельзя устанавливать дату отчета больше Точки Актуальности!");
		ДатаКонца=ПолучитьДатуТА(); 
	КонецЕсли;
КонецПроцедуры
//---------------------- 
Процедура ОстаткиПоТоварам()
	начЛог = семЗаписатьЛогНач( "Отчет", "Фин. остатки товаров", "Обработка", "Формирование отчета" );
	Заг="";
	Если ВыбФирма.Выбран()=1 Тогда
		Заг=Заг+"По фирме: "+СокрП(ВыбФирма.Наименование)+". ";
	Иначе
		Предупреждение("Выберите фирму!");
		Возврат;
	КонецЕсли;
	
    // Здесь формируется отчет, который использует регистры, критичные к 
    // последовательности проведения документов
    // поэтому сравним установленные даты периода формируемого отчета с ГП 
    ПроверкаАктуальностиОтчета('01.01.80',ДатаКонца,"Фин",ВыбФирма);

	Запрос=СоздатьОбъект("Запрос");

	Если ДатаКонца>=ПолучитьДатуТА() Тогда
		ДатаКонца=ПолучитьДатуТА();
		ТекстЗапроса="";
	Иначе
		ДатаКон=ДатаКонца-1; 
		ТекстЗапроса="
		|ПЕРИОД С ДатаКон По ДатаКонца;";
	КонецЕсли;

	ТекстЗапроса=ТекстЗапроса+"
	|Товар=Регистр.ПартииТоваров.Товар;
//	|ПрихДокумент=Регистр.ПартииТоваров.ПрихДокумент;
	|Фирма=Регистр.ПартииТоваров.Фирма;  
	|Склад=Регистр.ПартииТоваров.Склад;
	|Статус=Регистр.ПартииТоваров.Статус;
	|Стоимость=Регистр.ПартииТоваров.Стоимость;
	|НДС=Регистр.ПартииТоваров.НДС;
	|Кол=Регистр.ПартииТоваров.ОстатокТовара;";

	Если ВыбТовар.Выбран()=0 Тогда
		//Без условий
		Заг=Заг+"По всем товарам. ";
	ИначеЕсли ВыбТовар.ЭтоГруппа()=1 Тогда
		ТекстЗапроса=ТекстЗапроса+"Условие (Товар.ПринадлежитГруппе(ВыбТовар)=1);";
		Заг=Заг+"По товарам группы "+ВыбТовар.Наименование+". ";
	Иначе
		ТекстЗапроса=ТекстЗапроса+"Условие (Товар=ВыбТовар);";
		Заг=Заг+"По товару "+ВыбТовар.Наименование+". ";
	КонецЕсли;
     
	Если ВыбСклад.Выбран()=0 Тогда
		Заг=Заг+" По всем складам. ";
	Иначе
		ТекстЗапроса=ТекстЗапроса+"Условие (Склад=ВыбСклад);";
		Заг=Заг+" По складу "+ВыбСклад.Наименование+". ";
	КонецЕсли;	
	
	
	
	ТекстЗапроса=ТекстЗапроса+"
	|Условие (Фирма=ВыбФирма);
	|Группировка Товар Упорядочить по Товар.Код;
	|Группировка Статус;
//	|Группировка ПрихДокумент;
	|Функция КонКол=КонОст(Кол);
	|Функция КонСтоим=КонОст(Стоимость); 
	|Функция КонНДС=КонОст(НДС); 
	|";
	Флаг=Запрос.Выполнить(ТекстЗапроса);
	Если Флаг=0 Тогда
		Предупреждение("запрос по регистру ПартииТоваров не выполнился!");
		Возврат;
	КонецЕсли;

	ЧислоСтрок=0;
	ИтогоОстаток=0;
	ИтогоВалСто=0;
	ИтогоВалНДС=0;
	
	Если ФлагНДС=1 Тогда
		ЗагНДС="Стоимость указана с НДС";  
	Иначе
		ЗагНДС="Стоимость указана без НДС";  
	КонецЕсли;
	
	
	//  Создание Таблицы для выходного отчета
	Таб=СоздатьОбъект("Таблица");
	Таб.ИсходнаяТаблица("Таблица");
	Таб.ВывестиСекцию("Отчет");
	Оживить(4);
	
	Пока Запрос.Группировка("Товар") = 1 Цикл
		Если Запрос.Товар.Выбран()=0 Тогда
			Продолжить;
		КонецЕсли;
		Наим=Запрос.Товар.Наименование;
		Если Запрос.Товар.ЭтоГруппа()=1 Тогда
			Таб.ВывестиСекцию("Группа");
			Оживить(1);
			Продолжить;
		КонецЕсли;
		ПартииТовара=СоздатьОбъект("СписокЗначений"); 
		ВВ=Запрос.Товар.ВалютаУчета;
		
		ОбщКупленоСтоим=0; 
		ОбщКупленоОстат=0;       
		ОбщКупленоНДС=0;
		ОбщОтданоСтоим=0; 
		ОбщОтданоОстат=0;
		ОбщОтданоНДС=0;
		ОбщПринятоСтоим=0; 
		ОбщПринятоОстат=0;
		ОбщПринятоНДС=0;
		ОбщКонСтоим=0;   
		ОбщКонНДС=0;
		ОбщКонОстат=0; 
		Если ФлагНДС=1 Тогда
			ОбщКонСтоим=Запрос.КонСтоим+Запрос.КонНДС;  
		Иначе
			ОбщКонСтоим=Запрос.КонСтоим;  
		КонецЕсли;
		ОбщКонНДС=Запрос.КонНДС;
		ОбщКонОстат=Запрос.КонКол; 
		Пока Запрос.Группировка("Статус") = 1 Цикл 
			Если Запрос.Статус=Купленный Тогда  
				Если ФлагНДС=1 Тогда
					ОбщКупленоСтоим=Запрос.КонСтоим+Запрос.КонНДС;
				Иначе
					ОбщКупленоСтоим=Запрос.КонСтоим;
				КонецЕсли;
				ОбщКупленоНДС=Запрос.КонНДС;
				ОбщКупленоОстат=Запрос.КонКол; 
			ИначеЕсли Запрос.Статус=Отданный Тогда       
				Если ФлагНДС=1 Тогда
					ОбщОтданоСтоим=Запрос.КонСтоим+Запрос.КонНДС;
				Иначе
					ОбщОтданоСтоим=Запрос.КонСтоим;
				КонецЕсли;
				ОбщОтданоНДС=Запрос.КонНДС;
				ОбщОтданоОстат=Запрос.КонКол; 
			ИначеЕсли Запрос.Статус=Принятый Тогда 
				Если ФлагНДС=1 Тогда
					ОбщПринятоСтоим=Запрос.КонСтоим+Запрос.КонНДС;
				Иначе
					ОбщПринятоСтоим=Запрос.КонСтоим;
				КонецЕсли;
				ОбщПринятоНДС=Запрос.КонНДС;
				ОбщПринятоОстат=Запрос.КонКол; 
			КонецЕсли;
//			Пока Запрос.Группировка("ПрихДокумент") = 1 Цикл 
//			КонецЦикла;
		КонецЦикла;
		КупленоКол_во=Формат(ОбщКупленоОстат,"Ч12.3");
		ОтданоКол_во=Формат(ОбщОтданоОстат,"Ч12.3");
		ПринятоКол_во=Формат(ОбщПринятоОстат,"Ч12.3");
		
		КупленоСтоимость=ФРМ(ОбщКупленоСтоим,Рубли,1);
		ОтданоСтоимость=ФРМ(ОбщОтданоСтоим,Рубли,1);
		ПринятоСтоимость=ФРМ(ОбщПринятоСтоим,Рубли,1); 
		
		КупленоНДС=ФРМ(ОбщКупленоНДС,Рубли,1);
		ОтданоНДС=ФРМ(ОбщОтданоНДС,Рубли,1);
		ПринятоНДС=ФРМ(ОбщПринятоНДС,Рубли,1);
		
		ВалютнаяСтоимость=ФРМ(ОбщКонСтоим,Рубли,1);
		ВалютнаяНДС=ФРМ(ОбщКонНДС,Рубли,1);
	//	Если ФлагНДС=1 Тогда
	//		Цена=?(ОбщКонОстат<>0,ФРМ((ОбщКонСтоим+ОбщКонНДС)/ОбщКонОстат,Рубли,1),"");	
	//	Иначе	
			Цена=?(ОбщКонОстат<>0,ФРМ(ОбщКонСтоим/ОбщКонОстат,Рубли,1),"");
	//	КонецЕсли;
		Таб.ВывестиСекцию("Товар");
		ИтогоОстаток=ИтогоОстаток+ОбщКонОстат; 
		
		ИтогоВалСто=ИтогоВалСто+ОбщКонСтоим;
		ИтогоВалНДС=ИтогоВалНДС+ОбщКонНДС;
		Оживить(1);
	КонецЦикла;
	Таб.ВывестиСекцию("Итоги");
	Оживить(1);
	//Вызов выходного отчета в окно просмотра и редактирования.
	Таб.ТолькоПросмотр(1);
	Таб.Опции(0,0,4,0);
	Таб.Показать("Остатки товаров по учету партий товаров","");
	семЗаписатьЛогКон( начЛог );	
КонецПроцедуры
//-------------------------------
ДатаКонца=ПолучитьДатуТА();
ВыбФирма=Константа.ОсновнаяФирма;
ФлагНДС=0;