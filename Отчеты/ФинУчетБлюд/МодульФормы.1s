Перем ДокПодч;
Перем ТекущТовар;

Процедура ПриОткрытии()
	Если Константа.ПартииНаСкладах<>Перечисление.Булево.Да Тогда
		Форма.ВыбСклад.Видимость(0);
		Форма.КнопкаСклад.Видимость(0); 
		Форма.ТекстСкл.Видимость(0);
		ВыбСклад=0;
	КонецЕсли;	       
	
	глПриОткрытии(Контекст,"ФинУчетБлюд");
	
	
КонецПроцедуры     

Процедура Партии(Режим)
	начЛог = семЗаписатьЛогНач( "Отчет", "Фин. учет партий блюд", "Обработка", Шаблон("Формирование отчета ([Режим])") );
	Заг="";
	Если ВыбФирма.Выбран()=1 Тогда
		Заг=Заг+"По фирме: "+СокрП(ВыбФирма.Наименование)+". ";
	Иначе
		Предупреждение("Выберите фирму!");
		Возврат;
	КонецЕсли;
	
	ПроверкаАктуальностиОтчета(ДатаНачала,ДатаКонца,"Фин",ВыбФирма);
	
	Рег1=СоздатьОбъект("Регистр.ПартииТоваров");
	Если ДатаКонца>=ПолучитьДатуТА() Тогда
		ДатаКон=0;
		ДатаКонца=ПолучитьДатуТА();
	Иначе
		ДатаКон=ДатаКонца;
	КонецЕсли;
	
	Запрос=СоздатьОбъект("Запрос");
	ТекстЗапроса="
	|ПЕРИОД С ДатаНачала По ДатаКонца;
	|Товар=Регистр.ПартииТоваров.Товар;
	|Фирма=Регистр.ПартииТоваров.Фирма;
	|Статус=Регистр.ПартииТоваров.Статус;
	|ПрихДокумент=Регистр.ПартииТоваров.ПрихДокумент;
	|Докум=Регистр.ПартииТоваров.ТекущийДокумент;
	|ОстатокТовара=Регистр.ПартииТоваров.ОстатокТовара;
	|Стоимость=Регистр.ПартииТоваров.Стоимость;
	|НДС=Регистр.ПартииТоваров.НДС;
	|Оборот=Регистр.ПартииТоваров.Оборот;
	|НП=Регистр.ПартииТоваров.НП;  
	|КодОперации=Регистр.ПартииТоваров.КодОперации;  
	|СуммаНДС=Регистр.ПартииТоваров.НДСрасхода;";
	Если ВыбСклад.Выбран()<>0 Тогда         
		ТекстЗапроса=ТекстЗапроса+"
		|Склад=Регистр.ПартииТоваров.Склад;";
	КонецЕсли;
	ТекстЗапроса=ТекстЗапроса+"
	|Группировка Товар Без групп;
	|Группировка Статус;";
	Если (Режим="Подробный") ИЛИ (Режим="Развернутый") Тогда
		ТекстЗапроса=ТекстЗапроса+"
		|Группировка ПрихДокумент;";
	КонецЕсли;
	Если (Режим="Подробный")  Тогда
		ТекстЗапроса=ТекстЗапроса+"
		|Группировка Докум;";
	КонецЕсли;
	ТекстЗапроса=ТекстЗапроса+"
	|Функция НачОстатокТовара=НачОст(ОстатокТовара);
	|Функция КонОстатокТовара=КонОст(ОстатокТовара);
	|Функция ПрихОстатокТовара=Приход(ОстатокТовара);
	|Функция РасхОстатокТовара=Расход(ОстатокТовара);
	|Функция НачСтоимость=НачОст(Стоимость);
	|Функция НачНДС=НачОст(НДС);
	|Функция КонСтоимость=КонОст(Стоимость);
	|Функция КонНДС=КонОст(НДС);
	|Функция ПрихСтоимость=Приход(Стоимость);
	|Функция ПрихНДС=Приход(НДС);
	|Функция РасхСтоимость=Расход(Стоимость);
	|Функция РасхНДС=Расход(НДС);
	|Функция РасхСтоимостьДляПрофит=Расход(Стоимость) Когда (Оборот>0);
	|Функция РасхНДСДляПрофит=Расход(НДС) Когда (Оборот>0);
	|Функция ОборотТовара=Сумма(Оборот);
	|Функция НПТовара=Сумма(НП);
	|Функция НДСТовара=Сумма(СуммаНДС) Когда(Оборот>0);
	|Условие (Фирма=ВыбФирма); 
	|Условие (КодОперации<>Неизвестный); 
	|Условие (КодОперации<>ПроизводствоБлюда); 
	|";
	Если ВыбСклад.Выбран() <> 0 Тогда         
		ТекстЗапроса=ТекстЗапроса+"
		|Условие (Склад=ВыбСклад);"; 
		Заг=Заг+"   По складу: " + СокрП(ВыбСклад.Наименование)+". ";
	Иначе
		Заг=Заг+"   По всем складам"+". ";
	КонецЕсли;  
	
	Если ВыбТовар.Выбран()=0 Тогда
		Заг=Заг+"   По всем блюдам";
	ИначеЕсли ВыбТовар.ЭтоГруппа()=1 Тогда
		ТекстЗапроса=ТекстЗапроса+"Условие(Товар.ПринадлежитГруппе(ВыбТовар)=1);";
		Заг=Заг+"   По блюдам группы "+ВыбТовар.Наименование;
	Иначе
		ТекстЗапроса=ТекстЗапроса+"Условие(Товар=ВыбТовар);";
		Заг=Заг+"   По блюду " + ВыбТовар.Наименование;
	КонецЕсли;
	ТекстЗапроса=ТекстЗапроса+"Условие(Статус=Произведенный);";
	Флаг=Запрос.Выполнить(ТекстЗапроса);
	Если Флаг=0 тогда
		Предупреждение("Запрос по Партиям не выполнился!!!");
		Возврат;
	КонецЕсли;
	//  Создание Таблицы для выходного отчета
	Таб=СоздатьОбъект("Таблица");
	ИтогоНП=0;
	ЧислоСтрок=0;
	Таб.ВывестиСекцию("Отчет");
	Если Режим="Краткий" Тогда
		Таб.ВывестиСекцию("ШапкаТов");
	Иначе
		Таб.ВывестиСекцию("ШапкаДок");
	КонецЕсли;
	Оживить(4);
	Пока Запрос.Группировка("Товар") = 1 Цикл
		ТекТовар=Запрос.Товар;
		Если ТекТовар.Выбран()=0 Тогда
			Продолжить;
		КонецЕсли;
		ВУ=Рубли;
		ВП=Рубли;
		ПечТовар=СокрП(ТекТовар.Наименование);
		ПечНачальныйОстатокТовара=Запрос.НачОстатокТовара;
		ПечТекущийОстатокТовара=Запрос.КонОстатокТовара;
		ПечПриходОстатокТовара=Запрос.ПрихОстатокТовара;
		ПечРасходОстатокТовара=Запрос.РасхОстатокТовара; 
		Если ФлагНДС=1 Тогда
			ПечНачальныйСтоимость=ФРМ((Запрос.НачСтоимость+Запрос.НачНДС),ВУ,1);
			ПечТекущийСтоимость=ФРМ((Запрос.КонСтоимость+Запрос.КонНДС),ВУ,1);
			ПечПриходСтоимость=ФРМ((Запрос.ПрихСтоимость+Запрос.ПрихНДС),ВУ,1);
			ПечРасходСтоимость=ФРМ((Запрос.РасхСтоимость+Запрос.РасхНДС),ВУ,1);
		Иначе
			ПечНачальныйСтоимость=ФРМ(Запрос.НачСтоимость,ВУ,1);
			ПечТекущийСтоимость=ФРМ(Запрос.КонСтоимость,ВУ,1);
			ПечПриходСтоимость=ФРМ(Запрос.ПрихСтоимость,ВУ,1);
			ПечРасходСтоимость=ФРМ(Запрос.РасхСтоимость,ВУ,1);
		КонецЕсли;                                      
		ПечНачальныйНДС=ФРМ(Запрос.НачНДС,ВУ,1);
		ПечТекущийНДС=ФРМ(Запрос.КонНДС,ВУ,1);
		ПечПриходНДС=ФРМ(Запрос.ПрихНДС,ВУ,1);
		ПечРасходНДС=ФРМ(Запрос.РасхНДС,ВУ,1);
		
		Если Запрос.ОборотТовара>0 Тогда                                                 
			Если ФлагНДС=1 Тогда
			Профит=Запрос.ОборотТовара-Запрос.РасхСтоимостьДляПрофит-Запрос.РасхНДСДляПрофит;//-Запрос.НДСТовара;
		    Иначе
			Профит=Запрос.ОборотТовара-Запрос.РасхСтоимостьДляПрофит-Запрос.НДСТовара;
			КонецЕсли;
			ПечПрофит=?(Профит=0,"",ФРМ(Профит,ВУ,1)); 
			Если ФлагНДС=1 Тогда
				ПечПрофитПроц=?(Запрос.РасхСтоимостьДляПрофит=0,"",Формат(100*Профит/(Запрос.РасхСтоимостьДляПрофит+Запрос.РасхНДСДляПрофит),"Ч10.2")+" %");
			Иначе
				ПечПрофитПроц=?(Запрос.РасхСтоимостьДляПрофит=0,"",Формат(100*Профит/(Запрос.РасхСтоимостьДляПрофит),"Ч10.2")+" %");
			КонецЕсли;
			ПечОборот=ФРМ(Запрос.ОборотТовара,ВП,1);
			ПечНП=ФРМ(Запрос.НПТовара,ВП,1);
		Иначе
			Профит=0;
			ПечПрофит="";
			ПечПрофитПроц="";
			ПечОборот="";
			ПечНП="";
		КонецЕсли;
		
		Если НЕ(Режим="Краткий") Тогда
			Таб.ВывестиСекцию("ШапкаТов");
		КонецЕсли;
		Таб.ВывестиСекцию("Товар");
		Оживить(2);
		
		Пока Запрос.Группировка("Статус") = 1 Цикл
	
				Если (Режим="Подробный") ИЛИ (Режим="Развернутый") Тогда
					Пока Запрос.Группировка("ПрихДокумент") = 1 Цикл
						Док=Запрос.ПрихДокумент;
						ПечНачальныйОстатокДокум=Запрос.НачОстатокТовара;
						ПечТекущийОстатокДокум=Запрос.КонОстатокТовара;
						ПечПриходОстатокДокум=Запрос.ПрихОстатокТовара;
						ПечРасходОстатокДокум=Запрос.РасхОстатокТовара;
						ДатаКурса=?(Док.Выбран()=1,ДатаКурсаДок(Док),ДатаКонца);
						Если ФлагНДС=1 Тогда
							СебестПоДок=?(Запрос.ПрихОстатокТовара<>0,(Запрос.ПрихСтоимость+Запрос.ПрихНДС)/Запрос.ПрихОстатокТовара,?(Запрос.РасхОстатокТовара<>0,(Запрос.РасхСтоимость+Запрос.РасхНДС)/Запрос.РасхОстатокТовара,0));
						Иначе
							СебестПоДок=?(Запрос.ПрихОстатокТовара<>0,(Запрос.ПрихСтоимость)/Запрос.ПрихОстатокТовара,?(Запрос.РасхОстатокТовара<>0,(Запрос.РасхСтоимость)/Запрос.РасхОстатокТовара,0));
						КонецЕсли;
						ПечСебестПоДок=ФРМ(СебестПоДок,ВУ,1);
						Если Запрос.ОборотТовара>0 Тогда
							Если ФлагНДС=1 Тогда
								Профит=Запрос.ОборотТовара-Запрос.РасхСтоимостьДляПрофит-Запрос.РасхНДСДляПрофит;//-Запрос.НДСТовара;
							Иначе
								Профит=Запрос.ОборотТовара-Запрос.РасхСтоимостьДляПрофит-Запрос.НДСТовара;
							КонецЕсли;
							ПечПрофит=?(Профит=0,"",ФРМ(Профит,ВУ,1));
							Если ФлагНДС=1 Тогда
								ПечПрофитПроц=?(Запрос.РасхСтоимостьДляПрофит=0,"",Формат(100*Профит/(Запрос.РасхСтоимостьДляПрофит+Запрос.РасхНДСДляПрофит),"Ч10.2")+" %");
							Иначе
								ПечПрофитПроц=?(Запрос.РасхСтоимостьДляПрофит=0,"",Формат(100*Профит/(Запрос.РасхСтоимостьДляПрофит),"Ч10.2")+" %");
							КонецЕсли;
							ПечОборот=ФРМ(Запрос.ОборотТовара,ВП,1);
							ПечНП=ФРМ(Запрос.НПТовара,ВП,1);
						Иначе
							Профит=0;
							ПечПрофит="";
							ПечПрофитПроц="";
							ПечОборот="";
							ПечНП="";
						КонецЕсли;
						
						ПечНомерДок=Док.НомерДок;
						Таб.ВывестиСекцию("Партия");
						Оживить(1);
						БалансТовара= Запрос.НачОстатокТовара;
						Если (Режим="Подробный")  Тогда
							Пока Запрос.Группировка("Докум") = 1 Цикл
								Док=Запрос.Докум;
								ВидДок=Док.Вид();
								Если Док.Выбран()=0 Тогда // пропускаем непонятные документы
									Продолжить;
								КонецЕсли;
								
								ДатаКурса=ДатаКурсаДок(Док);
								ЦенаТовара=?(Запрос.РасхОстатокТовара<>0,Запрос.ОборотТовара/Запрос.РасхОстатокТовара,0);
								ПечЦенаТовара=?(ЦенаТовара=0,"",ФРМ(ЦенаТовара,ВП,1));
								БалансТовара=БалансТовара+Запрос.ПрихОстатокТовара-Запрос.РасхОстатокТовара;
								ПечНомерДок=СокрП(Док.НомерДок)+"; "+КлиентДок(Док);
								ПриращениеПрих=Запрос.ПрихОстатокТовара;
								ПриращениеРасх=Запрос.РасхОстатокТовара;
								
								Если Запрос.ОборотТовара>0 Тогда
									Если ФлагНДС=1 Тогда
										Профит=Запрос.ОборотТовара-Запрос.РасхСтоимостьДляПрофит-Запрос.РасхНДСДляПрофит;//-Запрос.НДСТовара;
									Иначе
										Профит=Запрос.ОборотТовара-Запрос.РасхСтоимостьДляПрофит-Запрос.НДСТовара;
									КонецЕсли;
									ПечПрофит=?(Профит=0,"",ФРМ(Профит,ВУ,1));
									Если ФлагНДС=1 Тогда
										ПечПрофитПроц=?(Запрос.РасхСтоимостьДляПрофит=0,"",Формат(100*Профит/(Запрос.РасхСтоимостьДляПрофит+Запрос.РасхНДСДляПрофит),"Ч10.2")+" %");
									Иначе
										ПечПрофитПроц=?(Запрос.РасхСтоимостьДляПрофит=0,"",Формат(100*Профит/(Запрос.РасхСтоимостьДляПрофит),"Ч10.2")+" %");
									КонецЕсли;
									ПечОборот=ФРМ(Запрос.ОборотТовара,ВП,1);
									ПечНП=ФРМ(Запрос.НПТовара,ВП,1);
								Иначе
									Профит=0;
									ПечПрофит="";
									ПечПрофитПроц="";
									ПечОборот="";
									ПечНП="";
								КонецЕсли;
								
								Если (Запрос.ПрихОстатокТовара<>0) Тогда// И (Запрос.РасхОстатокТовара=0) Тогда
									ПечПриращение=ПриращениеПрих;
									Таб.ВывестиСекцию("Приход");
								КонецЕсли;
								Если (Запрос.РасхОстатокТовара<>0) Тогда//  (Запрос.ПрихОстатокТовара=0) И
									ПечПриращение=ПриращениеРасх;
									Таб.ВывестиСекцию("Расход");
								КонецЕсли;
								
							КонецЦикла;
						КонецЕсли;
					КонецЦикла;
				КонецЕсли;
		
		КонецЦикла;
	КонецЦикла;
	Если ФлагНДС=1 Тогда
		ПечНачальныйСтоимость=ФРМ((Запрос.НачСтоимость+Запрос.НачНДС),ВУ,1);
		ПечТекущийСтоимость=ФРМ((Запрос.КонСтоимость+Запрос.КонНДС),ВУ,1);
		ПечПриходСтоимость=ФРМ((Запрос.ПрихСтоимость+Запрос.ПрихНДС),ВУ,1);
		ПечРасходСтоимость=ФРМ((Запрос.РасхСтоимость+Запрос.РасхНДС),ВУ,1);
	Иначе
		ПечНачальныйСтоимость=ФРМ(Запрос.НачСтоимость,ВУ,1);
		ПечТекущийСтоимость=ФРМ(Запрос.КонСтоимость,ВУ,1);
		ПечПриходСтоимость=ФРМ(Запрос.ПрихСтоимость,ВУ,1);
		ПечРасходСтоимость=ФРМ(Запрос.РасхСтоимость,ВУ,1);
	КонецЕсли;
	    ПечНачальныйНДС=ФРМ(Запрос.НачНДС,ВУ,1);
		ПечТекущийНДС=ФРМ(Запрос.КонНДС,ВУ,1);
		ПечПриходНДС=ФРМ(Запрос.ПрихНДС,ВУ,1);
		ПечРасходНДС=ФРМ(Запрос.РасхНДС,ВУ,1);
	
	Если Запрос.ОборотТовара>0 Тогда
		Если ФлагНДС=1 Тогда
			Профит=Запрос.ОборотТовара-Запрос.РасхСтоимостьДляПрофит-Запрос.РасхНДСДляПрофит;//-Запрос.НДСТовара;
		Иначе
			Профит=Запрос.ОборотТовара-Запрос.РасхСтоимостьДляПрофит-Запрос.НДСТовара;
		КонецЕсли;
		ПечПрофит=?(Профит=0,"",ФРМ(Профит,ВУ,1));
		Если ФлагНДС=1 Тогда
			ПечПрофитПроц=?(Запрос.РасхСтоимостьДляПрофит=0,"",Формат(100*Профит/(Запрос.РасхСтоимостьДляПрофит+Запрос.РасхНДСДляПрофит),"Ч10.2")+" %");
		Иначе
			ПечПрофитПроц=?(Запрос.РасхСтоимостьДляПрофит=0,"",Формат(100*Профит/(Запрос.РасхСтоимостьДляПрофит),"Ч10.2")+" %");
		КонецЕсли;
		ПечОборот=ФРМ(Запрос.ОборотТовара,ВП,1);
		ПечНП=ФРМ(Запрос.НПТовара,ВП,1);
	Иначе
		Профит=0;
		ПечПрофит="";
		ПечПрофитПроц="";
		ПечОборот="";
		ПечНП="";
	КонецЕсли;
	Таб.ВывестиСекцию("Итого");
	Оживить(1);
	
	//Вызов выходного отчета в окно просмотра и редактирования.
	Таб.ТолькоПросмотр(1);
	Таб.Опции(0,0,4,0);
	Таб.Показать("Отчет фин. учета блюд","");
	семЗаписатьЛогКон( начЛог );	
КонецПроцедуры

ДатаКонца=ПолучитьДатуТА();
ДатаНачала=Константа.ОсновнаяДатаНачалаОтчета;
Если Число(ДатаНачала)=0 Тогда
	ДатаНачала='01.01.98';
Конецесли;
ДокПодч=СоздатьОбъект("Документ");
ВыбФирма=Константа.ОсновнаяФирма;
ФлагНДС=0;