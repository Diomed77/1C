Перем Рег1;
Перем Рег2;
Перем КалькКартаНов;
//--------------------------------------------------------------------
Функция ПеренестиЗамену(ЗамСтар,ККНов)
	ДокЗаменаНовый=СоздатьОбъект("Документ.ЗаменаИнгредиента");
	глСоздатьНовыйОбъект(ДокЗаменаНовый);
	ДокЗаменаНовый.ДатаДок=ДатаПересчета;
	ДокЗаменаНовый.ТоварШапки=ЗамСтар.ТоварШапки;
	ДокЗаменаНовый.ДокОснование=ККНов.ТекущийДокумент();
	ЗамСтар.ВыбратьСтроки();
	Пока ЗамСтар.ПолучитьСтроку()=1 Цикл
		ДокЗаменаНовый.НоваяСтрока();
		ДокЗаменаНовый.Замена=ЗамСтар.Замена; 
		Если ЗамСтар.КоэффициентЗамены=0 Тогда 
			ДокЗаменаНовый.КоэффициентЗамены=1;	
		Иначе	
			ДокЗаменаНовый.КоэффициентЗамены=ЗамСтар.КоэффициентЗамены;
		КонецЕсли;
	КонецЦикла;
	//Закомментировано Инсталлятором МОД:ДокЗаменаНовый.Записать();
	//Начало текста, вставленного Инсталлятором МОД
	ОбъектЗаписать(ДокЗаменаНовый, );
	//Конец текста, вставленного Инсталлятором МОД

	ДокЗаменаНовый.Провести();
	Возврат ДокЗаменаНовый.ТекущийДокумент();
КонецФункции
//--------------------------------------------------------------------
Процедура ВычСебСто(Ингредиент,ТоварШапки)
	Остаток=Рег1.СводныйОстаток(Ингредиент,,,"ОстатокТовара");
	ВалБлюда=ТоварШапки.ВалютаЗакупки;
	ВалИнгр=Ингредиент.ВалютаЗакупки;         
	ПроцНДС=ПроцентНДС(Ингредиент.СтавкаНДС); 
	Если Остаток<=0 Тогда
		Если Константа.КалькулироватьСНДС=Перечисление.Булево.Нет Тогда
			ЦенаРасчета=Ингредиент.ЦенаПриобретения*(100/(100+ПроцНДС));                                
		Иначе
			ЦенаРасчета=Ингредиент.ЦенаПриобретения; 
		КонецЕсли; 
		Если ВалБлюда.Код=ВалИнгр.Код Тогда
			ЦенаК=ЦенаРасчета;
		ИначеЕсли (ВалБлюда.Код<>ВалИнгр.Код) И (ВалИнгр.Код=Константа.БазоваяВалюта.Код) Тогда
			ЦенаК=ЦенаРасчета/ВалБлюда.Курс;
		Иначе
			ЦенаК=ЦенаРасчета*ВалИнгр.Курс/ВалБлюда.Курс;
		КонецЕсли;
	Иначе
		Стоим=Рег2.СводныйОстаток("",Ингредиент,,,,,"Стоимость");
		НДСстоим=Рег2.СводныйОстаток("",Ингредиент,,,,,"НДС");
		Остат=Рег2.СводныйОстаток("",Ингредиент,,,,,"ОстатокТовара");
		Если Остат<>0 Тогда
			Если Константа.КалькулироватьСНДС=Перечисление.Булево.Нет Тогда
				ЦенаРасчета=Стоим/Остат;                                
			Иначе
				ЦенаРасчета=(Стоим+НДСстоим)/Остат;  
			КонецЕсли; 
		Иначе
			Если Константа.КалькулироватьСНДС=Перечисление.Булево.Нет Тогда
				ЦенаРасчета=Ингредиент.ЦенаПриобретения*(100/(100+ПроцНДС));
			Иначе
				ЦенаРасчета=Ингредиент.ЦенаПриобретения; 
			КонецЕсли; 
		КонецЕсли;	
		Если ВалБлюда.Код=Константа.БазоваяВалюта.Код Тогда
			ЦенаК=ЦенаРасчета;
		Иначе
			ЦенаК=ЦенаРасчета/ВалБлюда.Курс;
		КонецЕсли;
	КонецЕсли;
	КалькКартаНов.Цена=ЦенаК;
КонецПроцедуры
//--------------------------------------------------------------------
Процедура ОпределитьУровеньВложенности(Ингредиент)
	Если  Ингредиент.ВидТовара=Перечисление.ВидыТоваров.Блюдо Тогда
		УрБлюда=Ингредиент.ИмеетБлюда;
		Если  УрБлюда>=КалькКартаНов.УровеньВложенности Тогда
			КалькКартаНов.УровеньВложенности=УрБлюда+1;
		Иначе
			КалькКартаНов.УровеньВложенности=КалькКартаНов.УровеньВложенности+1;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры
//--------------------------------------------------------------------
Процедура ВычСуммыСеб()
	Если КалькКартаНов.КоэфСписания=100 Тогда
		КалькКартаНов.Количество=0;
		КалькКартаНов.Сумма=0;
		КалькКартаНов.СуммаРозн=0;
		Возврат;
	Иначе	
		КоличествоПром=(КалькКартаНов.КоличествоНетто*100)/(100-КалькКартаНов.КоэфСписания);
	КонецЕсли;
	Если  КалькКартаНов.СезонКоэф=100 Тогда
		КалькКартаНов.Количество=0;
		КалькКартаНов.Сумма=0;
		КалькКартаНов.СуммаРозн=0;
		Возврат;
	Иначе	
		КалькКартаНов.Количество=(КоличествоПром*100)/(100-КалькКартаНов.СезонКоэф);
	КонецЕсли;
	КалькКартаНов.Сумма=КалькКартаНов.Цена*КалькКартаНов.Количество*КалькКартаНов.Коэффициент;
	ПроцНДС=ПроцентНДС(КалькКартаНов.Ингредиент.СтавкаНДС);
	Если Константа.КалькулироватьСНДС=Перечисление.Булево.Да Тогда
		КалькКартаНов.СуммаРозн=КалькКартаНов.Сумма*(1+(КалькКартаНов.Наценка/100));
	Иначе
		КалькКартаНов.СуммаРозн=КалькКартаНов.Сумма*(1+(КалькКартаНов.Наценка/100))*(100+ПроцНДС)/100;
	КонецЕсли;
КонецПроцедуры                     
//--------------------------------------------------------------------
Процедура УстСебестоимостьКК(ЭлСпрБл)
	ЕстьКалькуляция=0;
	СуммаРозн=0;
	ДокумКальк=ПолучитьКалькуляцию(ДатаПересчета,ЭлСпрБл);
	Если ДокумКальк<>0 Тогда
		ЕстьКалькуляция=1;
	КонецЕсли;
	Если ЕстьКалькуляция=0 Тогда
		Предупреждение( "Не обнаружена Калькуляционная карта на "+ЭлСпрБл.Наименование+" !!!",1);
	Иначе
		КалькКартаНов=СоздатьОбъект("Документ.КалькуляционнаяКарта");
		глСоздатьНовыйОбъект(КалькКартаНов);
		КалькКартаНов.ДатаДок=ДатаПересчета;
		КалькКартаНов.АвтоВремяКонецДня();
		КалькКартаНов.ТоварШапки=ДокумКальк.ТоварШапки;
		КалькКартаНов.КоличествоКалькуляции=ДокумКальк.ТоварШапки.КоличествоКалькуляции;
		КалькКартаНов.Калькулятор=ДокумКальк.Калькулятор;
		КалькКартаНов.НомерРецептур=ДокумКальк.НомерРецептур;
		//Закомментировано Инсталлятором МОД:КалькКартаНов.Записать();
	//Начало текста, вставленного Инсталлятором МОД
	ОбъектЗаписать(КалькКартаНов, );
	//Конец текста, вставленного Инсталлятором МОД

		ДокумКальк.ВыбратьСтроки();
		Пока ДокумКальк.ПолучитьСтроку()=1 Цикл
			КалькКартаНов.НоваяСтрока();
			КалькКартаНов.Ингредиент=ДокумКальк.Ингредиент;
			КалькКартаНов.КоличествоНетто=ДокумКальк.КоличествоНетто;
			КалькКартаНов.Единица=ДокумКальк.Единица;
			КалькКартаНов.Коэффициент=ДокумКальк.Коэффициент;
			Если Изменять=1 Тогда
				Если ПустоеЗначение(ДокумКальк.Ингредиент.ОбработкаПоУмолчанию)=1 Тогда
					КалькКартаНов.КоэфСписания=ДокумКальк.Ингредиент.КоэффициентСписания;
				Иначе
					КалькКартаНов.ВидОбработки=ДокумКальк.Ингредиент.ОбработкаПоУмолчанию;
					КалькКартаНов.КоэфСписания=ДокумКальк.Ингредиент.ОбработкаПоУмолчанию.КоэффВыхода;
				КонецЕсли;
			Иначе
				Если ПустоеЗначение(ДокумКальк.ВидОбработки)=0 Тогда
					КалькКартаНов.ВидОбработки=ДокумКальк.ВидОбработки;	
				КонецЕсли;
				КалькКартаНов.КоэфСписания=ДокумКальк.КоэфСписания;
			КонецЕсли;
			КалькКартаНов.Наценка=ДокумКальк.Наценка;
			КалькКартаНов.СезонКоэф=УстановитьСезонныйКоэффициент(КалькКартаНов.Ингредиент,РабочаяДата());
			ВычСебСто( КалькКартаНов.Ингредиент, КалькКартаНов.ТоварШапки);
			ВычСуммыСеб();
			ОпределитьУровеньВложенности(КалькКартаНов.Ингредиент);
			Если Перенос=1 Тогда
				Если ДокумКальк.Замена.Выбран()=1 Тогда
					КалькКартаНов.Замена=ПеренестиЗамену(ДокумКальк.Замена,КалькКартаНов);
				КонецЕсли;
			КонецЕсли;
			СуммаРозн=СуммаРозн+КалькКартаНов.СуммаРозн ;
		КонецЦикла; 
		Если Константа.УстановкаЦеныРеализации=Перечисление.УстанЦенРеализ.Автоматически Тогда
			КалькКартаНов.РозничнаяЦена=Окр((СуммаРозн/КалькКартаНов.КоличествоКалькуляции),2);
			Если Константа.КалькулироватьСНДС=Перечисление.Булево.Нет Тогда	
				ПроцНДС=ПроцентНДС(КалькКартаНов.ТоварШапки.СтавкаНДС); 
				КалькКартаНов.ОбщаяНаценка=((КалькКартаНов.РозничнаяЦена-КалькКартаНов.РозничнаяЦена*ПроцНДС/(100+ПроцНДС))-(КалькКартаНов.Итог("Сумма")/КалькКартаНов.КоличествоКалькуляции))/(КалькКартаНов.Итог("Сумма")/КалькКартаНов.КоличествоКалькуляции)*100;
			Иначе
				КалькКартаНов.ОбщаяНаценка=(КалькКартаНов.РозничнаяЦена-(КалькКартаНов.Итог("Сумма")/КалькКартаНов.КоличествоКалькуляции))/(КалькКартаНов.Итог("Сумма")/КалькКартаНов.КоличествоКалькуляции)*100;
			КонецЕсли;	
		Иначе
			КалькКартаНов.ОбщаяНаценка=ДокумКальк.ОбщаяНаценка;
		КонецЕсли;
		//Закомментировано Инсталлятором МОД:КалькКартаНов.Записать();
	//Начало текста, вставленного Инсталлятором МОД
	ОбъектЗаписать(КалькКартаНов, );
	//Конец текста, вставленного Инсталлятором МОД
 
		КалькКартаНов.Провести();
	КонецЕсли;
	Состояние(""+ЭлСпрБЛ +" - Пересчитан!");
КонецПроцедуры
//--------------------------------------------------------------------
Процедура СформироватьНовая()
	Спр=СоздатьОбъект("Справочник.Номенклатура");
	Для i=0 по Константа.МаксУровеньВложенности Цикл
		Спр.ВыбратьЭлементы();
		Пока Спр.ПолучитьЭлемент()=1 Цикл
			Если (Спр.ЭтоГруппа()=1) Или (Спр.ПометкаУдаления()=1) Тогда
				Продолжить;
			КонецЕсли;
			Если Спр.ВидТовара=Перечисление.ВидыТоваров.Блюдо Тогда
				Если Спр.ИмеетБлюда=i Тогда
					УстСебестоимостьКК(Спр.ТекущийЭлемент());
				Иначе
					Продолжить;
				КонецЕсли;
			Иначе
				Продолжить;
			КонецЕсли;
		КонецЦикла; // кон цикла по товару-блюдам  без вхождений других блюд
	КонецЦикла;
КонецПроцедуры
//--------------------------------------------------------------------
Рег1=СоздатьОбъект("Регистр.ОстаткиТоваров");
Рег2=СоздатьОбъект("Регистр.ПартииТоваров");
ДатаПересчета = РабочаяДата();
Если ДатаПересчета>= ПолучитьДатуТА() Тогда
	ДатаПересчета = ПолучитьДатуТА();
КонецЕсли;
Если ДатаПересчета< ПолучитьДатуТА() Тогда
	Рег1.ВременныйРасчет();
	Рег2.ВременныйРасчет();
	РассчитатьРегистрыПо(ДатаПересчета);
КонецЕсли;
